<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>克苏鲁神话TRPG角色卡</title>
    <style>
        :root {
            --text-color: #333;
            --border-color: #666;
            --bg-color: #f5f5f5;
            --section-bg: #e9e9e9;
            --input-bg: #fff;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", Arial, sans-serif;
            font-size: 11px;
        }
        
        /* 页面标题样式 */
        .page-title {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #333;
            color: white;
            text-align: center;
            padding: 8px 0;
            font-size: 18px;
            font-weight: bold;
            z-index: 1001; /* 确保在悬浮导航按钮之上 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* 为内容添加足够的上边距，确保标题不在A4幅面内 */
        html {
            padding-top: 40px;
        }
        
        /* A4纸张在屏幕上的尺寸调整，确保标题在外部 */
        .character-sheet, .custom-page {
            margin-top: 10px !important; /* 增加顶部边距，确保标题与页面有明显分隔 */
            border-top: 1px dashed #ccc; /* 添加虚线边框，视觉上区分标题和页面 */
        }
        
        /* 分页符样式调整，避免产生空白页 */
        .page-break {
            display: none; /* 在页面切换模式下不需要分页符 */
        }
        
        /* 打印时隐藏标题并调整页面 */
        @media print {
            /* 控制页面尺寸和边距 */
            @page {
                size: A4 portrait; /* 保持A4纵向 */
                margin: 0.5cm;
            }
            
            /* 隐藏打印时不需要的元素 */
            .page-title {
                display: none !important;
            }
            
            html {
                padding-top: 0 !important;
            }
            
            /* 保持原始页面布局，但移除外部边框和阴影 */
            .character-sheet, .custom-page {
                margin: 0 !important;
                border: none !important; /* 移除黑色外边框 */
                border-top: none !important;
                width: auto !important; /* 保持原始宽度 */
                height: auto !important; /* 保持原始高度 */
                box-shadow: none !important; /* 移除阴影 */
                /* 移除所有缩放 */
                transform: none !important;
                /* 内部填充调整，补偿边框移除 */
                padding: 0 !important;
            }
            
            /* 确保颜色正确打印 */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* 彻底隐藏所有分页符，防止产生多余空白页 */
            .page-break {
                display: none !important;
                height: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                page-break-after: avoid !important;
                page-break-before: avoid !important;
                visibility: hidden !important;
                position: absolute !important;
            }
            
            /* 确保所有内部区域边框正常显示 */
            .sheet-section {
                border: 1px solid var(--border-color) !important;
                margin: 2px !important;
            }
            
            /* 禁止所有元素在打印时产生分页 */
            * {
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
                page-break-before: avoid !important;
            }
            
            /* 隐藏所有不必要的元素 */
            body::after {
                content: none !important;
            }
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 11px !important;
            line-height: 1.2;
            padding: 2px;
            max-width: 21cm; /* A4宽度 */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .character-sheet, .custom-page {
            border: 1px solid var(--border-color);
            padding: 5px;
            background-color: white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            width: 21cm; /* A4宽度 */
            box-sizing: border-box;
            page-break-inside: avoid;
            margin: 2px auto 10px auto;
        }
        
        .character-sheet {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-gap: 4px;
            min-height: auto; /* 移除固定高度限制，让内容自适应 */
            min-height: 29.7cm; /* A4高度 */
        }
        
        .custom-page {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-height: 29.7cm; /* 使用固定的A4高度 */
            max-height: none; /* 移除最大高度限制 */
        }
        
        /* 打印时的A4设置 */
        @page {
            size: A4 portrait;
            margin: 0;
        }
        @media print {
            body {
                width: 100%;
                padding: 0;
                margin: 0;
            }
            .character-sheet, .custom-page {
                width: 21cm;
                height: 29.7cm;
                margin: 0;
                padding: 5px;
                box-shadow: none;
                border: none;
            }
            
            .custom-page {
                margin-top: 0;
                page-break-before: always;
                min-height: 29.7cm; /* 确保打印时也有正确的最小高度 */
                padding-bottom: 0 !important; /* 移除底部内边距 */
            }
        }
        .sheet-section {
            background-color: var(--section-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 3px;
            margin-bottom: 3px;
        }
        
        /* 专门为调查员区域和属性区域设置背景 */
        .basic-info-section, .characteristics-section {
            background-color: var(--section-bg) !important; /* 使用深色背景 */
        }
        
        /* 直接强制这两个区域内所有input使用白色背景 */
        .basic-info-section input, 
        .basic-info-section .field-input,
        .characteristics-section input,
        .characteristics-section .char-value,
        .characteristic-item input,
        .characteristic-item .char-value {
            background-color: white !important;
            border: 1px solid #ddd !important;
        }
        
        .section-title {
            font-size: 14px !important;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2px;
            padding-bottom: 2px;
        }
        .total-attr {
            font-size: 12px !important;
            font-weight: normal;
            white-space: nowrap; /* 防止文本换行 */
            display: inline-flex; /* 使用inline-flex确保内容不会断行 */
            flex-wrap: nowrap; /* 禁止换行 */
            align-items: center;
            margin-left: auto; /* 确保总点数靠右显示 */
        }
        .field-row {
            display: flex;
            margin-bottom: 3px;
            align-items: center;
        }
        .field-label {
            font-size: 11px;
            min-width: 40px;
            margin-right: 5px;
        }
        .field-input {
            flex: 1;
            padding: 3px 5px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background-color: var(--input-bg);
        }
        
        /* 添加双列布局样式 */
        .field-row.double {
            display: flex;
            justify-content: space-between;
            gap: 3px;
            margin-bottom: 3px;
        }
        .field-group {
            display: flex;
            align-items: center;
            flex: 1;
        }
        .field-group .field-label {
            width: 40px;
            min-width: 40px;
            margin-right: 5px;
        }
        
        input, select {
            border: 1px solid var(--border-color);
            padding: 1px 3px;
            border-radius: 3px;
            background-color: var(--input-bg);
            width: 100%;
            height: 18px;
        }
        .characteristics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            margin-bottom: 2px;
        }
        .characteristic-item {
            text-align: center;
            border: none; /* 移除整体边框 */
            border-radius: 3px;
            padding: 2px;
            background-color: transparent; /* 移除背景色 */
        }
        .char-label {
            font-weight: normal;
            font-size: 11px;
            white-space: nowrap;
            margin-bottom: 3px; /* 添加底部间距 */
        }
        .char-value {
            font-size: 11px;
            font-weight: normal;
            text-align: center;
            -moz-appearance: textfield;
            border: 1px solid var(--border-color); /* 为输入框添加边框 */
            background-color: var(--input-bg); /* 为输入框添加背景色 */
            border-radius: 3px; /* 为输入框添加圆角 */
            padding: 2px 0; /* 增加垂直内边距 */
            width: 90%; /* 控制输入框宽度 */
            margin: 0 auto; /* 水平居中 */
        }
        .char-value::-webkit-outer-spin-button,
        .char-value::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .stats-section {
            grid-column: span 3;
            margin-bottom: 4px;
        }
        .stats-container {
            display: flex;
            justify-content: space-between;
            gap: 4px;
            width: 100%;
        }
        .stat-box {
            flex: 1;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 1px;
            text-align: center;
            background-color: var(--input-bg);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .stat-title {
            font-size: 12px !important;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1px;
            padding-bottom: 1px;
            color: #444;
            text-align: center;
        }
        .stat-icon {
            margin-right: 5px;
            font-size: 14px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            align-items: center;
            padding: 0 4px;
        }
        .stat-label {
            font-size: 11px;
            font-weight: normal;
            color: #555;
            margin-bottom: 0;
            white-space: nowrap;
        }
        .stat-value {
            width: 24px;
            height: 14px;
            text-align: center;
            padding: 0;
            font-size: 11px;
            border: 1px solid #ccc;
            border-radius: 2px;
            background-color: #f9f9f9;
        }
        .avatar-section {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 3px;
            height: auto;
        }
        .avatar-container {
            width: 138px;
            height: 138px;
            aspect-ratio: 1;
            border: 1px solid var(--border-color);
            margin: 1px auto 3px;
            background-color: var(--input-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }
        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
        .avatar-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(245, 245, 245, 0.9);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .avatar-container:hover .avatar-placeholder {
            opacity: 1;
        }
        .avatar-placeholder-icon {
            font-size: 24px;
            margin-bottom: 5px;
            color: #666;
        }
        .avatar-placeholder-text {
            font-size: 11px;
            text-align: center;
            color: #666;
            padding: 0 10px;
        }
        .hidden-file-input {
            display: none;
        }
        .skills-section {
            grid-column: span 3;
            margin-top: 2px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            border: 1px solid black !important;
            border-radius: 4px;
            padding: 3px;
        }
        .skills-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1px;
            padding-bottom: 1px;
            gap: 15px; /* 增加容器之间的间距，从默认的间距增加到15px */
        }
        .points-container {
            display: flex;
            align-items: center;
            padding: 1px;
            background-color: transparent;
            margin-left: 3px;
            width: auto;
        }
        .points-label {
            width: 60px;
            font-weight: normal;
            font-size: 11px;
            white-space: nowrap;
        }
        .points-input {
            width: 36px; /* 从40px减小到36px，只需容纳3位数字 */
            text-align: center;
            min-width: 36px; /* 添加最小宽度确保一致性 */
            max-width: 36px; /* 添加最大宽度避免拉伸 */
        }
        .points-remaining {
            margin-left: 3px;
            font-style: italic;
            width: auto; /* 从50px改为auto，让内容决定宽度 */
            font-weight: normal;
            white-space: nowrap;
            display: flex; /* 添加flex布局 */
            align-items: center; /* 垂直居中 */
        }
        .skills-grid {
            display: flex;
            flex-direction: column;
            background-color: #ddd;
            gap: 1px;
            flex-grow: 1;
        }
        .skill-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
        }
        .skill-row:nth-child(odd) .skill-item {
            background-color: #ffffff !important;
        }
        .skill-row:nth-child(even) .skill-item {
            background-color: #f0f0f0 !important;
        }
        .skills-header-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2px;
            margin-top: 0;
            margin-bottom: 1px;
            background-color: #ddd;
        }
        .skills-header-item {
            display: flex;
            align-items: center;
            padding: 0 2px;
            font-weight: normal;
            background-color: #e0e0e0;
            border: none;
            border-radius: 0;
            min-height: 18px;
            justify-content: space-between;
        }
        .skills-header-name {
            flex: 2;
            min-width: 100px;
            text-align: left;
        }
        .skills-header-points {
            display: flex;
            align-items: center;
            flex: 2;
            justify-content: space-between;
        }
        .skills-header-base, 
        .skills-header-occupation, 
        .skills-header-interest, 
        .skills-header-growth {
            width: 25px;
            text-align: center;
            margin: 0 1px;
            flex: 0 0 25px;
            font-size: 10px;
        }
        .skills-header-total {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            margin-left: 3px;
            flex: 1;
        }
        .skills-header-success {
            text-align: center;
            min-width: 22px;
            font-size: 10px;
        }
        .skill-item {
            display: flex;
            align-items: center;
            border: none;
            padding: 0 2px;
            margin-bottom: 0;
            border-radius: 0;
            background-color: var(--input-bg);
            font-size: 11px;
            min-height: 18px;
            justify-content: space-between;
            box-shadow: none;
            transition: background-color 0.2s;
        }
        /* 删除单独的奇数行样式 */
        .skill-item:nth-child(odd) {
            background-color: var(--input-bg);
        }
        /* 删除悬停样式，以保持一致的背景色 */
        .skill-item:hover {
            background-color: var(--input-bg);
        }
        /* 删除第一个子元素的特殊边框 */
        .skill-item:first-child {
            border-top: none;
        }
        .skill-checkbox {
            margin-right: 3px;
            width: 12px;
            height: 12px;
            transform: scale(0.8);
            flex: 0 0 auto;
        }
        .skill-name {
            flex: 2;
            font-size: 11px;
            display: flex;
            flex-direction: row;
            align-items: center;
            min-width: 68px; /* 从70px减小到68px */
            overflow: hidden;
        }
        .skill-name-text {
            margin-right: 3px;
            font-weight: normal;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 68px; /* 从70px减小到68px */
            font-size: 11px;
        }
        .skill-subtype {
            width: 70px; /* 从90px减少到70px */
            max-width: 70px;
            font-size: 10px;
            margin-left: 2px;
            padding: 1px;
            height: 18px;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1; /* 允许下拉菜单占据剩余空间 */
        }
        .skill-point-input {
            width: 25px;
            text-align: center;
            margin: 0;
            padding: 0;
            font-size: 11px;
            -moz-appearance: textfield;
            max-length: 3;
            flex: 0 0 25px;
            height: 16px;
        }
        .skill-base {
            width: 25px;
            font-size: 11px;
            text-align: center;
            background-color: var(--section-bg);
            padding: 0;
            border-radius: 2px;
            margin: 0;
            flex: 0 0 25px;
            height: 14px;
            line-height: 14px;
        }
        .skill-total {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            margin-left: 3px;
            flex: 1;
        }
        .skill-result {
            font-size: 11px;
            background-color: var(--section-bg);
            padding: 0;
            text-align: center;
            border-radius: 2px;
            min-width: 22px;
            height: 14px;
            line-height: 14px;
        }
        .skills-header-points {
            display: flex;
            align-items: center;
            flex: 2;
            justify-content: space-between;
        }
        .skills-header-base, 
        .skills-header-occupation, 
        .skills-header-interest, 
        .skills-header-growth {
            width: 25px;
            text-align: center;
            margin: 0 1px;
            flex: 0 0 25px;
            font-size: 10px;
        }
        .skills-header-success {
            text-align: center;
            min-width: 22px;
            font-size: 10px;
        }
        .skill-points {
            display: flex;
            align-items: center;
            flex: 2;
            justify-content: space-between;
            gap: 3px; /* 从5px减小到3px，整体压缩间距 */
            margin-left: -2px; /* 添加负边距使基础值向左移动 */
        }
        .multi-row-skill {
            grid-column: span 2;
            background-color: inherit;
        }
        .empty-row {
            height: 18px; /* 与skill-item高度一致 */
            visibility: hidden;
        }
        .language-skills, .fight-skills, .shooting-skills, .science-skills, 
        .art-skills, .survival-skills, .drive-skills {
            display: grid;
            grid-template-columns: 1fr;
            gap: 3px;
        }
        .native-language {
            grid-column: span 2;
        }
        .foreign-language {
            grid-column: span 2;
        }
        
        /* 打印样式 */
        @media print {
            /* 确保打印时背景色和颜色可见，并设置最高优先级 */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* 确保技能区域标题不分行 */
            .section-title, .section-title span, .total-attr {
                white-space: nowrap !important;
                overflow: visible !important;
                display: inline-flex !important;
                align-items: center !important;
                flex-wrap: nowrap !important;
                width: auto !important; /* 对span和total-attr设置自动宽度 */
            }
            
            /* 确保section-title在打印时宽度为100% */
            .section-title {
                width: 100% !important;
                display: flex !important;
                justify-content: space-between !important;
                border-bottom: 1px solid var(--border-color) !important;
            }
            
            /* 确保总点数在打印时靠右显示 */
            .total-attr {
                margin-left: auto !important;
            }
            
            /* 基本打印样式 */
            body {
                padding: 0;
                background-color: var(--bg-color);
            }
            
            .character-sheet {
                border: 1px solid var(--border-color);
                box-shadow: none;
                padding: 5px;
                background-color: white;
            }
            
            /* 隐藏输入框边框和统一背景色 */
            input, select, textarea, .field-input, .char-value, .skill-point-input, .stat-value, .points-input {
                border: none !important;
                background-color: var(--section-bg) !important; /* 统一使用section-bg背景色 */
                box-shadow: none !important;
                -webkit-appearance: none !important;
                appearance: none !important;
                padding: 2px !important;
                border-radius: 2px !important;
            }
            
            /* 专门确保调查员区域和属性区域输入框样式 */
            .field-input, .char-value, input[type="text"], input[type="number"] {
                background-color: var(--section-bg) !important;
                color: var(--text-color) !important;
            }
            
            /* 高优先级选择器 - 调查员区域输入框使用白色背景 */
            body .basic-info-section input, 
            body .basic-info-section .field-input,
            body .sheet-section:first-child input, 
            body .sheet-section:first-child .field-input,
            .character-sheet .basic-info-section input,
            .character-sheet .basic-info-section .field-input,
            .field-row input, 
            .field-group input {
                background-color: var(--input-bg) !important; /* 使用白色变量 */
                border: 1px solid #ddd !important; /* 淡灰色边框 */
            }
            
            /* 高优先级选择器 - 属性区域输入框使用白色背景 */
            body .characteristics-section input,
            body .characteristics-section .char-value,
            body .characteristics-grid input,
            body .characteristics-grid .char-value,
            body .characteristic-item input,
            body #str, body #con, body #dex, body #app, 
            body #siz, body #edu, body #int, body #pow, body #luc,
            .character-sheet .characteristics-section input,
            .character-sheet .characteristics-grid input,
            .character-sheet .characteristic-item input {
                background-color: var(--input-bg) !important; /* 使用白色变量 */
                border: 1px solid #ddd !important; /* 淡灰色边框 */
            }
            
            /* 隐藏下拉菜单中的"选择..."和"自定义..."选项 */
            select.skill-subtype option[value=""],
            select.skill-subtype option[value="custom"] {
                display: none !important;
            }
            
            /* 隐藏未选择值的下拉菜单 */
            select.skill-subtype.empty-select {
                display: none !important;
            }
            
            /* 隐藏上传头像提示 */
            .avatar-placeholder {
                display: none !important;
            }
            
            /* 确保点数输入区域不换行且剩余显示在同一行 */
            .skills-header {
                display: flex;
                flex-wrap: nowrap !important;
                white-space: nowrap !important;
                width: 100% !important;
                gap: 15px !important; /* 打印时也保持间距为15px */
            }
            
            .points-container {
                flex-shrink: 0 !important;
                white-space: nowrap !important;
                display: flex !important;
                align-items: center !important;
            }
            
            .points-label, .points-remaining {
                white-space: nowrap !important;
                display: flex !important;
                align-items: center !important;
            }
            
            /* 确保技能名字在打印时完整显示 */
            .skill-name-text {
                max-width: none !important;
                overflow: visible !important;
                white-space: nowrap !important;
                flex-shrink: 0 !important;
            }
            
            /* 完全移除所有可能导致0值隐藏的打印规则 */
            .skill-result:empty, 
            .skill-result:not(:empty):not([data-filled="true"]),
            .skill-base:empty, 
            .skill-base:not(:empty)[data-zero="true"] {
                visibility: visible !important;
                color: var(--text-color) !important;
            }
            
            /* 确保所有技能值在打印时可见 */
            .skill-base, 
            .skill-result {
                visibility: visible !important;
                color: var(--text-color) !important;
                background-color: var(--section-bg) !important;
            }
            
            /* 重新定义明确的打印棋盘格样式 */
            .odd-row .left-column-cell {
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
                visibility: visible !important;
            }
            .odd-row .right-column-cell {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
                visibility: visible !important;
            }
            .even-row .left-column-cell {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
                visibility: visible !important;
            }
            .even-row .right-column-cell {
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
                visibility: visible !important;
            }
            
            /* 隐藏选择和更改按钮 */
            .skill-subtype-btn {
                display: none !important;
            }
            
            /* 确保选择的子技能名称正确显示 */
            .skill-subtype-display {
                display: inline-block !important;
                color: var(--text-color) !important;
                font-style: normal !important;
                margin-left: 0 !important;
            }
            
            /* 确保打印时不显示页眉页脚 */
            @page {
                margin: 0.5cm;
                size: auto;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* 属性区域中的幸运输入框使用白色背景 */
            .luck-input, 
            input.field-input.luck-input {
                background-color: white !important; /* 幸运输入框使用白色背景 */
            }
            
            /* 打印时输入框样式 */
            .char-value {
                border: none !important;
                background-color: white !important; /* 改为白色背景 */
                width: 60% !important; /* 打印时让输入框适当变窄 */
            }
            
            /* 属性区域布局调整 */
            .characteristic-item {
                padding: 0 !important;
                margin-bottom: 3px !important;
            }
            
            .char-label {
                margin-bottom: 2px !important;
            }
            
            /* 打印时属性区域输入框样式 - 使用高特异性选择器确保应用 */
            .sheet-section:nth-child(2) .char-value,
            .sheet-section:nth-child(2) input[type="number"],
            .sheet-section:nth-child(2) input[type="text"],
            .characteristic-item .char-value,
            .characteristics-grid input,
            #str, #con, #dex, #app, #siz, #edu, #int, #pow, #luc {
                background-color: white !important; /* 白色背景 */
                border: none !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* 确保不受全局规则影响 */
            .characteristics-grid input.char-value {
                background-color: white !important; /* 再次指定白色背景，确保优先级 */
            }
            
            /* 确保自定义技能的基础值在打印时可见 */
            .custom-skill-base {
                visibility: visible !important;
                color: var(--text-color) !important;
                background-color: var(--section-bg) !important;
            }
            
            /* 确保所有技能结果值显示 */
            .custom-skill-result {
                visibility: visible !important;
                color: var(--text-color) !important;
                background-color: var(--section-bg) !important;
            }
        }
        
        /* 全局样式 - 确保0值在打印和普通显示时都可见 */
        .skill-base, .skill-result {
            min-width: 22px;
            visibility: visible !important;
            color: var(--text-color) !important;
        }
        
        /* 确保打印前JS函数能正确处理0值显示 */
        
        input[type="text"] {
            border: 1px solid var(--border-color);
            padding: 3px 5px;
            border-radius: 3px;
            background-color: var(--input-bg);
            width: 100%;
            text-align: center;
        }
        .skill-points {
            display: flex;
            align-items: center;
            flex: 2;
            justify-content: space-between;
            gap: 5px;
        }
        /* 横向布局样式 */
        .stat-content {
            display: flex;
            justify-content: space-around;
            padding: 0;
            margin-top: 2px;
            width: 100%;
            gap: 2px;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 30%;
        }
        .stat-label {
            font-size: 11px;
            font-weight: normal;
            color: #555;
            margin-bottom: 0;
            white-space: nowrap;
        }
        .stat-value {
            width: 24px;
            height: 14px;
            text-align: center;
            padding: 0;
            font-size: 11px;
            border: 1px solid #ccc;
            border-radius: 2px;
            background-color: #f9f9f9;
        }
        /* 普通文字样式统一 */
        .field-label,
        .char-label,
        .stat-label,
        .points-label,
        .skill-name-text,
        .skill-base,
        .skill-result,
        .points-remaining,
        .skills-header-item,
        .skills-header-base,
        .skills-header-occupation,
        .skills-header-interest,
        .skills-header-success,
        .skill-subtype,
        .skill-subtype option,
        .skill-point-input,
        .points-input,
        .avatar-placeholder-text,
        .char-value {
            font-size: 11px !important;
        }
        /* 确保所有输入框内的文字大小一致 */
        input, select, option {
            font-size: 11px;
        }
        /* 保持属性值的字体与普通文字一致 */
        .char-value {
            font-size: 11px;
            font-weight: normal;
            text-align: center;
            -moz-appearance: textfield;
        }
        /* 确保角色卡内所有普通文字统一 */
        .skill-item {
            font-size: 11px;
        }
        /* 添加更高优先级的全局字体样式 */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 11px !important;
            line-height: 1.2;
            padding: 2px;
            max-width: 21cm; /* A4宽度 */
            margin: 0 auto;
        }
        /* 确保所有文本输入元素都是统一字体大小 */
        input, select, option, textarea, button, label, .field-input, .char-value, .skill-point-input {
            font-size: 11px !important;
        }
        /* 确保唯一例外是区域标题和次级标题 */
        .section-title {
            font-size: 14px !important;
            font-weight: bold;
        }
        .stat-title, .total-attr {
            font-size: 12px !important;
        }
        /* 其他可能有特定字体大小的元素 */
        .skills-header-base, 
        .skills-header-occupation, 
        .skills-header-interest, 
        .skills-header-growth,
        .skills-header-success,
        .skill-base,
        .skill-result {
            font-size: 11px !important;
        }
        .luck-input {
            width: 90% !important; /* 与其他属性输入框宽度一致 */
            max-width: none !important; /* 移除最大宽度限制 */
            flex: none !important;
            text-align: center !important; /* 文本居中 */
            margin: 0 auto !important; /* 水平居中 */
        }
        /* 优化技能区域的标题和点数布局 */
        .skills-section .section-title {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2px;
            padding-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* 修改角色状态区域 */
        .stat-content {
            display: flex;
            justify-content: space-around;
            padding: 0;
            margin-top: 2px;
            width: 100%;
            gap: 2px;
        }
        .stat-box {
            flex: 1;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 1px;
            text-align: center;
            background-color: var(--input-bg);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .stat-title {
            font-size: 12px !important;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1px;
            padding-bottom: 1px;
            color: #444;
            text-align: center;
        }
        .stat-label {
            font-size: 11px;
            font-weight: normal;
            color: #555;
            margin-bottom: 0;
            white-space: nowrap;
        }
        .skills-header-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2px;
            margin-top: 0;
            margin-bottom: 1px;
            background-color: #ddd;
        }
        /* 优化技能表格内部元素 */
        .skills-grid {
            display: flex;
            flex-direction: column;
            background-color: #ddd;
            gap: 1px;
        }
        .skill-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
        }
        .skill-row:nth-child(odd) .skill-item {
            background-color: #ffffff !important;
        }
        .skill-row:nth-child(even) .skill-item {
            background-color: #f0f0f0 !important;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 11px !important;
            line-height: 1.2;  /* 从1.3减小到1.2 */
            padding: 2px;  /* 从5px减小到2px */
            max-width: 21cm; /* A4宽度 */
            margin: 0 auto;
        }
        .skill-item[style*="grid-column: span 2"] {
            background-color: #f0f0f0; /* 与奇数行颜色一致 */
            border-bottom: 1px solid #ddd;
            font-weight: normal; /* 从bold改为normal */
        }
        .skill-item[style*="grid-column: span 2"] .skill-name-text {
            font-weight: normal; /* 从bold改为normal */
            color: #444;
        }
        /* 确保空行也有适当的背景色 */
        .skill-row:nth-child(even):empty {
            background-color: #ffffff;
            height: 18px;
        }
        .skill-row:nth-child(odd):empty {
            background-color: #f0f0f0;
            height: 18px;
        }
        /* 添加子技能样式 */
        .subtype-skill {
            /* 删除对背景色的任何限制 */
        }
        
        /* 子技能文本样式 */
        .subtype-skill .skill-name-text:empty:before {
            content: "\00a0"; /* 空格，保持布局 */
        }

        /* 针对子技能项的特殊样式 */
        .subtype-skill .skill-name {
            display: flex;
            align-items: center;
        }
        
        .subtype-skill .skill-name-text {
            flex-shrink: 0; /* 防止名称被压缩 */
        }

        /* 添加固定的列交替样式类 */
        .left-column-cell {
            background-color: #f0f0f0 !important;
        }
        .right-column-cell {
            background-color: #ffffff !important;
        }
        
        /* 棋盘格样式 */
        .odd-row .left-column-cell {
            background-color: #ffffff !important;
        }
        .odd-row .right-column-cell {
            background-color: #f0f0f0 !important;
        }
        .even-row .left-column-cell {
            background-color: #f0f0f0 !important;
        }
        .even-row .right-column-cell {
            background-color: #ffffff !important;
        }

        /* 统一所有输入框背景色 */
        input[type="text"], 
        input[type="number"],
        .field-input, 
        .char-value, 
        .skill-point-input, 
        .skill-base,
        .stat-value, 
        .points-input,
        select {
            background-color: var(--input-bg) !important;
        }

        /* 移除可能影响输入框背景色的样式 */
        .skill-base:empty, 
        .skill-base:not(:empty)[data-zero="true"],
        .skill-result:empty, 
        .skill-result:not(:empty)[data-filled="false"] {
            background-color: var(--section-bg) !important;
        }

        /* 确保所有技能值区域都有相同的背景色 */
        .skill-base, .skill-result {
            background-color: var(--section-bg) !important;
        }

        /* 打印样式调整 */
        @media print {
            /* 隐藏输入框边框，但保持一致的背景色 */
            input[type="text"], 
            input[type="number"],
            .field-input, 
            .char-value, 
            .skill-point-input,
            .points-input,
            select {
                border: none !important;
                background-color: transparent !important;
            }

            /* 确保技能值区域在打印时仍有一致的背景色 */
            .skill-base, 
            .skill-result {
                background-color: var(--section-bg) !important;
            }

            /* 当值为空或0时只隐藏文本，但保留背景色 */
            .skill-base[data-zero="true"],
            .skill-result[data-filled="false"] {
                color: transparent !important;
                background-color: var(--section-bg) !important;
            }
            
            /* 移除技能项和自定义技能项的所有边框和阴影 */
            .skill-item, .custom-skill-item, 
            .skill-row, .custom-skill-row,
            .skills-container, .custom-skills-container,
            .skills-section, .custom-skills-section {
                border: none !important;
                box-shadow: none !important;
                -webkit-box-shadow: none !important;
                -moz-box-shadow: none !important;
                background-color: var(--input-bg) !important;
                print-color-adjust: exact !important;
            }
            
            /* 确保技能行之间没有边框 */
            .skill-row:not(:last-child), .custom-skill-row:not(:last-child) {
                border-bottom: none !important;
            }
            
            /* 移除技能项和自定义技能项内部元素的边框 */
            .skill-name, .custom-skill-name,
            .skill-points, .custom-skill-points,
            .skill-total, .custom-skill-total {
                border: none !important;
                box-shadow: none !important;
            }
        }

        /* 添加一个全局规则确保打印和普通显示都能看到0值 */
        .skill-base, .skill-result {
            min-width: 22px;
            visibility: visible !important;
            color: var(--text-color) !important;
        }

        /* 新增模态窗口样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }
        .modal-content {
            position: relative;
            background-color: #fff;
            margin: 10% auto;
            padding: 0;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            animation: modalopen 0.4s;
        }
        @keyframes modalopen {
            from {opacity: 0; transform: translateY(-10px);}
            to {opacity: 1; transform: translateY(0);}
        }
        .modal-header {
            padding: 8px 16px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 16px !important;
            font-weight: bold;
            margin: 0;
        }
        .close-modal {
            color: #aaa;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal:hover {
            color: #000;
        }
        .modal-body {
            padding: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .subtype-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        .subtype-item {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background-color: #f9f9f9;
            transition: all 0.2s;
        }
        .subtype-item:hover {
            background-color: #e9e9e9;
            border-color: #aaa;
        }
        .subtype-category {
            grid-column: 1 / -1;
            margin-top: 10px;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            color: #555;
        }
        .custom-input-container {
            margin-top: 15px;
            display: flex;
            gap: 8px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        #custom-subtype-input {
            flex: 1;
            padding: 6px 10px;
        }
        #confirm-custom {
            padding: 6px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #confirm-custom:hover {
            background-color: #45a049;
        }image.png
        .skill-subtype-btn {
            margin-left: 5px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 1px 5px;
            font-size: 10px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90px;
            display: inline-block;
        }
        .skill-subtype-btn:hover {
            background-color: #e0e0e0;
        }
        .skill-subtype-display {
            margin-left: 5px;
            color: #0066cc;
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90px;
            display: inline-block;
        }
        
        /* 分页和新页面样式 */
        .page-break {
            page-break-after: always;
            height: 0;
            display: none;
        }
        
        .custom-page {
            border: 1px solid var(--border-color);
            padding: 5px;
            background-color: white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); /* 修改阴影效果，与custom-page一致 */
            border: 1px solid var(--border-color); /* 使用与custom-page一致的边框颜色变量 */
            box-sizing: border-box;
            position: relative;
            justify-content: flex-start; /* 内容从顶部开始排列 */
            gap: 4px; /* 添加元素间间距，与custom-page一致 */
        }
        
        /* 调查员引用区域，移除多余边框 */
        .investigator-reference {
            background-color: var(--section-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 24px;
        }
        
        .investigator-reference .section-title {
            border-bottom: none !important;
            margin-bottom: 0; 
            padding-bottom: 0;
            display: flex;
            align-items: center;
            height: 100%;
            font-size: 14px !important;
            font-weight: bold;
        }
        
        .investigator-info {
            display: flex;
            align-items: center;
            height: 100%;
            margin-left: auto;
        }
        
        .investigator-data {
            display: flex;
            align-items: center;
            white-space: nowrap;
            height: 100%;
        }
        
        .investigator-field {
            display: flex;
            align-items: center;
            height: 100%;
        }
        
        .investigator-label, .investigator-value {
            display: flex;
            align-items: center;
            height: 100%;
        }
        
        .investigator-label {
            font-weight: bold;
            margin-right: 5px;
            font-size: 11px;
        }
        
        .investigator-value {
            font-size: 11px;
        }
        
        .partner-checkbox-container {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            margin-left: auto;
            padding-right: 2px;
        }
        
        .partner-checkbox {
            width: 12px;
            height: 12px;
            margin: 0;
            transform: scale(0.9);
            cursor: pointer;
        }
        
        /* 打印样式 */
        @media print {
            .partner-checkbox {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        /* 自定义技能区域 */
        .sheet-section.custom-skills-section {
            background-color: #ddd !important; /* 与其他区域保持一致的深色背景 */
            border: 1px solid black !important;
            border-radius: 4px !important;
            padding: 3px !important;
            display: flex;
            flex-direction: column;
            flex: 1 0 auto;
        }
        
        .custom-skills-grid {
            display: flex;
            flex-direction: column;
            background-color: #ddd !important;
            gap: 1px;
            flex: 1 0 auto;
        }
        
        .custom-skill-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
        }
        
        /* 添加自定义技能区域的棋盘格效果 */
        .custom-skill-row:nth-child(odd) .custom-skill-item {
            background-color: #ffffff !important;
        }
        
        .custom-skill-row:nth-child(even) .custom-skill-item {
            background-color: #f0f0f0 !important;
        }
        
        .custom-skill-item {
            display: flex;
            align-items: center;
            border: none;
            padding: 0 5px;
            margin-bottom: 0;
            border-radius: 0;
            background-color: var(--input-bg);
            font-size: 11px;
            min-height: 22px;
            justify-content: space-between;
            box-shadow: none;
        }
        
        .custom-skill-name {
            flex: 2;
            font-size: 11px;
            display: flex;
            flex-direction: row;
            align-items: center;
            min-width: 100px;
        }
        
        .custom-skill-name-input {
            width: 100%;
            font-size: 11px;
            border: 1px solid #ddd;
            border-radius: 2px;
            padding: 1px 3px;
            background-color: white;
        }
        
        .custom-skill-points {
            display: flex;
            align-items: center;
            flex: 2;
            justify-content: space-between;
            gap: 1px;
        }
        
        .custom-skill-base {
            width: 25px;
            font-size: 11px;
            text-align: center;
            background-color: var(--section-bg);
            padding: 0;
            border-radius: 2px;
            margin: 0;
            flex: 0 0 25px;
            height: 14px;
            line-height: 14px;
            color: var(--text-color) !important; /* 确保文字颜色可见 */
        }
        
        .custom-skill-point-input {
            width: 25px;
            text-align: center;
            margin: 0;
            padding: 0;
            font-size: 11px;
            -moz-appearance: textfield;
            max-length: 3;
            flex: 0 0 25px;
            height: 16px;
            border: 1px solid #ccc;
            border-radius: 2px;
        }
        
        .custom-skill-total {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            margin-left: 3px;
            flex: 1;
        }
        
        .custom-skill-result {
            font-size: 11px;
            background-color: var(--section-bg);
            padding: 0;
            text-align: center;
            border-radius: 2px;
            min-width: 22px;
            height: 14px;
            line-height: 14px;
        }
        
        /* 棋盘格样式 */
        .custom-odd-row .custom-left-column-cell {
            background-color: #ffffff !important;
        }
        .custom-odd-row .custom-right-column-cell {
            background-color: #f0f0f0 !important;
        }
        .custom-even-row .custom-left-column-cell {
            background-color: #f0f0f0 !important;
        }
        .custom-even-row .custom-right-column-cell {
            background-color: #ffffff !important;
        }
        
        /* 打印样式优化 */
        @media print {
            /* 控制页面大小和边距 */
            @page {
                size: A4;
                margin: 0.5cm;
            }
            
            /* 防止意外分页 */
            .character-sheet, .custom-page {
                page-break-inside: avoid;
                max-height: none; /* 打印时移除最大高度限制 */
                box-shadow: none;
            }
            
            /* 确保分页符生效 */
            .page-break {
                page-break-after: always;
                height: 0;
                display: block;
                clear: both;
            }
            
            /* 隐藏输入技能名称的placeholder */
            .custom-skill-name-input::placeholder {
                color: transparent !important;
            }
            
            /* 进一步确保所有技能表相关元素没有边框阴影 */
            .skills-grid, .custom-skills-grid,
            .skills-header-row, .skills-header-item,
            .skill-points div, .custom-skill-points div,
            .skill-total div, .custom-skill-total div {
                border: none !important;
                box-shadow: none !important;
                -webkit-box-shadow: none !important;
                text-shadow: none !important;
                filter: none !important;
            }
            
            /* 清除所有可能影响打印的装饰效果 */
            .skill-odd-row, .skill-even-row,
            .custom-odd-row, .custom-even-row,
            .left-column-cell, .right-column-cell,
            .custom-left-column-cell, .custom-right-column-cell {
                box-shadow: none !important;
                border: none !important;
                filter: none !important;
            }
        }
        
        /* 武器区域 */
        .weapon-section {
            grid-column: span 2; /* 改回占2列 */
            margin-top: 5px;
        }
        
        .weapon-header-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 将三列宽度均分 */
            gap: 5px;
            margin-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 3px;
        }
        
        .weapon-header-item {
            font-weight: bold;
            text-align: center;
            font-size: 11px;
        }
        
        .weapon-grid {
            display: flex;
            flex-direction: column;
            gap: 1px; /* 与技能行一致 */
        }
        
        .weapon-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 将三列宽度均分 */
            gap: 5px;
            align-items: center;
            min-height: 18px; /* 与技能行高度一致 */
        }
        
        /* 实现奇偶行不同背景色，与技能区域一致 */
        .weapon-row:nth-child(odd) {
            background-color: #f0f0f0;
        }
        
        .weapon-row:nth-child(even) {
            background-color: #ffffff;
        }
        
        .weapon-name, .weapon-damage, .weapon-feature {
            font-size: 11px;
            padding: 2px 4px;
            min-height: 18px;
            display: flex;
            align-items: center;
            cursor: text;
            position: relative;
        }
        
        .weapon-name-text, .weapon-damage-text, .weapon-feature-text {
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .weapon-name-input, .weapon-damage-input, .weapon-feature-input {
            width: 100%;
            padding: 3px 5px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 11px;
            background-color: white;
            min-height: 18px; /* 与技能行高度一致 */
            display: none; /* 默认隐藏输入框 */
            position: absolute;
            left: 0;
            top: 0;
            z-index: 10;
        }
        
        /* 确保打印时颜色一致 */
        @media print {
            .weapon-row:nth-child(odd) {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .weapon-row:nth-child(even) {
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        /* 悬浮导航按钮组样式 */
        .float-nav {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .float-nav-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .float-nav-button:hover {
            background-color: #f0f0f0;
            transform: scale(1.05);
        }
        
        .float-nav-button:active {
            background-color: #e0e0e0;
            transform: scale(0.95);
        }
        
        /* 按钮内部图标占位 */
        .float-nav-icon {
            width: 20px;
            height: 20px;
            background-color: #333;
            mask-size: contain;
            mask-repeat: no-repeat;
            mask-position: center;
            -webkit-mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-position: center;
        }
        
        /* 定义每个按钮的图标 */
        .float-nav-button:nth-child(1) .float-nav-icon {
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M9 3L5 6.99h3V14h2V6.99h3L9 3zm7 14.01V10h-2v7.01h-3L15 21l4-3.99h-3z'/%3E%3C/svg%3E");
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M9 3L5 6.99h3V14h2V6.99h3L9 3zm7 14.01V10h-2v7.01h-3L15 21l4-3.99h-3z'/%3E%3C/svg%3E");
        }
        
        .float-nav-button:nth-child(2) .float-nav-icon {
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-2V9h-2V7h4v10z'/%3E%3C/svg%3E");
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-2V9h-2V7h4v10z'/%3E%3C/svg%3E");
        }
        
        .float-nav-button:nth-child(3) .float-nav-icon {
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z'/%3E%3C/svg%3E");
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z'/%3E%3C/svg%3E");
        }
        
        .float-nav-button:nth-child(4) .float-nav-icon {
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22l-1.92 3.32c-.12.21-.07.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z'/%3E%3C/svg%3E");
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22l-1.92 3.32c-.12.21-.07.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z'/%3E%3C/svg%3E");
        }
        
        .float-nav-button:nth-child(5) .float-nav-icon {
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z'/%3E%3C/svg%3E");
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z'/%3E%3C/svg%3E");
        }
        
        /* 打印时隐藏导航按钮 */
        @media print {
            .float-nav {
                display: none !important;
            }
            @page {
                size: A4;
                margin: 0;
                zoom: 96%;
                -webkit-transform: scale(0.96);
                transform: scale(0.96);
            }
            html, body {
                width: 100%;
                height: 100%;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .character-sheet {
                zoom: 96%;
                -webkit-transform: scale(0.96);
                transform: scale(0.96);
                transform-origin: top left;
            }
        }
        
        /* 移除所有技能表元素的边框和阴影 */
        .skills-grid, .custom-skills-grid,
        .skill-item, .custom-skill-item,
        .skill-row, .custom-skill-row,
        .skills-section, .custom-skills-section,
        .skills-container, .custom-skills-container,
        .skills-header-row, .skills-header-item,
        .skill-name, .custom-skill-name,
        .skill-points, .custom-skill-points,
        .skill-total, .custom-skill-total,
        .skill-point-input, .custom-skill-point-input,
        .skill-base, .skill-result,
        .custom-skill-base, .custom-skill-result {
                border: none !important;
            box-shadow: none !important;
            -webkit-box-shadow: none !important;
            text-shadow: none !important;
        }
        
        /* 覆盖任何可能导致边框出现的样式 */
        .skill-odd-row, .skill-even-row,
        .custom-odd-row, .custom-even-row,
        .left-column-cell, .right-column-cell,
        .custom-left-column-cell, .custom-right-column-cell {
            box-shadow: none !important;
                border: none !important;
            }
            
        /* 确保背景色正确打印 */
        * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            color-adjust: exact !important;
        }
        /* 战斗区域 */
        .combat-section {
            grid-column: span 1; /* 占1列 */
            margin-top: 5px;
            background-color: var(--section-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px;
        }
        
        .combat-grid {
            display: flex;
            flex-direction: column;
            gap: 3px; /* 从1px增加到3px，提供更好的行间距 */
        }
        
        .combat-row {
            display: flex;
            align-items: center;
            min-height: 20px; /* 从18px增加到20px，提供更好的垂直空间 */
            white-space: nowrap; /* 确保文字不分行 */
            margin-bottom: 1px; /* 添加小的底部边距 */
        }
        
        .combat-label {
            width: 65%; /* 进一步增加宽度比例，为更长的英文单词预留空间 */
            font-size: 11px;
            font-weight: normal; /* 改为正常字重，不加粗 */
            padding-right: 5px;
            white-space: nowrap; /* 确保文字不分行 */
            overflow: hidden; /* 防止文本溢出 */
            text-overflow: ellipsis; /* 文本溢出时显示省略号 */
        }
        
        .combat-value {
            width: 35%; /* 相应调整输入框区域的宽度 */
            display: flex;
            align-items: center;
        }
        
        .combat-input {
            width: 100%;
            padding: 2px 4px; /* 调整为与武器输入框一致的内边距 */
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 11px;
            background-color: white;
            min-height: 18px; /* 与技能行高度一致 */
        }
        
        /* 确保打印时战斗区域样式一致 */
        @media print {
            body .character-sheet .combat-section {
                border: 1px solid black !important; /* 使用更高优先级选择器和明确的黑色边框 */
                border-width: 1px !important;
                border-style: solid !important;
                border-color: black !important;
                box-shadow: none !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .combat-input {
                border: none !important;
                background-color: white !important; /* 改为白色背景 */
            }
            
            /* 确保打印时文字不分行 */
            .combat-row, .combat-label {
                white-space: nowrap !important;
                overflow: visible !important;
                display: flex !important;
                align-items: center !important;
                min-height: 20px !important; /* 更新为与常规视图一致的高度 */
                margin-bottom: 1px !important; /* 确保打印时也有底部边距 */
            }
            
            /* 打印时保持布局比例 */
            .combat-label {
                width: 65% !important;
                font-weight: normal !important; /* 确保打印时文字不加粗 */
            }
            
            .combat-value {
                width: 35% !important;
            }
            
            /* 确保战斗区域输入框在打印时使用白色背景 */
            html body .character-sheet .combat-section .combat-input {
                background-color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        /* 通用区域边框样式 */
        .section-border {
            border: 1px solid black !important;
            border-radius: 4px !important;
            padding: 3px !important;
        }

        /* 应用边框样式到所有主要区域 */
        .basic-info-section,
        .characteristics-section,
        .skills-section,
        .combat-section,
        .weapons-section,
        .backstory-section,
        .assets-section,
        .spells-section,
        .custom-page {
            border: 1px solid black !important;
            border-radius: 4px !important;
            padding: 3px !important;
        }

        /* 打印样式确保边框显示 */
        @media print {
            .basic-info-section,
            .characteristics-section,
            .skills-section,
            .combat-section,
            .weapons-section,
            .backstory-section,
            .assets-section,
            .spells-section,
            .custom-page {
                border: 1px solid black !important;
                border-width: 1px !important;
                border-style: solid !important;
                border-color: black !important;
                border-radius: 4px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }

        /* 打印样式 */
        @media print {
            /* 隐藏自定义技能页的输入框 */
            .custom-skill-name-input,
            .custom-skill-point-input,
            .custom-occupation-points,
            .custom-interest-points,
            .custom-growth-points {
                display: none !important;
            }

            /* 自定义技能名称显示为纯文本 */
            .custom-skill-name {
                padding: 0 2px;
            }

            /* 确保打印时颜色一致 */
            .weapon-row:nth-child(odd) {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .weapon-row:nth-child(even) {
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        /* 打印样式 */
        @media print {
            /* 自定义技能页样式优化 */
            .custom-skills-section {
                background-color: #ddd !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* 隐藏输入框并调整布局 */
            .custom-skill-name-input,
            .custom-skill-point-input,
            .custom-occupation-points,
            .custom-interest-points,
            .custom-growth-points {
                display: none !important;
            }

            /* 调整技能项布局 */
            .custom-skill-item {
                display: grid !important;
                grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr !important;
                gap: 2px !important;
                padding: 2px 5px !important;
                align-items: center !important;
                min-height: 18px !important;
            }

            /* 技能名称区域 */
            .custom-skill-name {
                grid-column: 1 !important;
                padding: 0 2px !important;
                text-align: left !important;
            }

            /* 基础值和点数区域 */
            .custom-skill-points {
                grid-column: 2 / 6 !important;
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 2px !important;
                text-align: center !important;
            }

            /* 成功率区域 */
            .custom-skill-total {
                grid-column: 6 / 9 !important;
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 2px !important;
                text-align: center !important;
            }

            /* 数值显示样式 */
            .custom-skill-base,
            .custom-skill-result {
                background-color: #f9f9f9 !important;
                padding: 1px 2px !important;
                border-radius: 2px !important;
                min-width: 22px !important;
                text-align: center !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* 奇偶行背景色 */
            .custom-skill-row:nth-child(odd) .custom-skill-item {
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .custom-skill-row:nth-child(even) .custom-skill-item {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* 确保表头样式正确 */
            .skills-header-row {
                background-color: #ddd !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .skills-header-item {
                padding: 2px 5px !important;
            }
        }

        @media print {
            /* 自定义技能表格行间距调整 */
            .custom-skills-grid {
                gap: 2px !important; /* 增加行间距 */
            }

            .custom-skill-row {
                margin-bottom: 1px !important; /* 每行底部添加间距 */
            }

            .custom-skill-item {
                min-height: 20px !important; /* 略微增加行高 */
                padding: 2px 5px !important;
            }

            /* 确保表头和内容之间有适当间距 */
            .skills-header-row {
                margin-bottom: 2px !important;
            }

            /* 确保颜色一致 */
            .custom-skill-row:nth-child(odd) .custom-skill-item {
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .custom-skill-row:nth-child(even) .custom-skill-item {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        /* 保存按钮样式 */
        .save-icon {
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23333' d='M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* 加载提示框样式 */
        .load-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 300px;
        }

        .load-dialog-content {
            text-align: center;
            margin-bottom: 15px;
        }

        .load-dialog-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .load-dialog-button {
            padding: 5px 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #f0f0f0;
            cursor: pointer;
        }

        .load-dialog-button:hover {
            background: #e0e0e0;
        }

        .load-dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* 头像区域样式 */
        .avatar-section {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 3px;
            height: auto;
        }

        .avatar-container {
            width: 138px;
            height: 138px;
            aspect-ratio: 1;
            border: 1px solid var(--border-color);
            margin: 1px auto 3px;
            background-color: var(--input-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        /* 打印样式优化 */
        @media print {
            /* 使用最高优先级选择器确保头像区域在打印时正确显示 */
            html body .character-sheet .avatar-section {
                padding: 3px !important;
                height: auto !important;
                page-break-inside: avoid !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: stretch !important;
            }
            
            html body .character-sheet .avatar-section .avatar-container {
                width: 138px !important;
                height: 138px !important;
                aspect-ratio: 1 !important;
                border: 1px solid var(--border-color) !important;
                margin: 1px auto 3px !important;
                background-color: var(--input-bg) !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                overflow: hidden !important;
                position: relative !important;
                cursor: default !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            html body .character-sheet .avatar-section .avatar-img {
                width: 100% !important;
                height: 100% !important;
                object-fit: cover !important;
                object-position: center !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
                max-width: none !important;
                max-height: none !important;
            }
            
            /* 隐藏上传提示 */
            html body .character-sheet .avatar-section .avatar-placeholder {
                display: none !important;
            }
            
            /* 确保头像区域标题正确显示 */
            html body .character-sheet .avatar-section .section-title {
                font-size: 14px !important;
                font-weight: bold !important;
                border-bottom: 1px solid var(--border-color) !important;
                margin-bottom: 2px !important;
                padding-bottom: 2px !important;
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
            }
        }

        /* 确保头像在普通显示时也正确显示 */
        .avatar-section {
            display: flex !important;
            flex-direction: column !important;
            align-items: stretch !important;
            padding: 3px !important;
            height: auto !important;
        }

        .avatar-container {
            width: 138px !important;
            height: 138px !important;
            aspect-ratio: 1 !important;
            border: 1px solid var(--border-color) !important;
            margin: 1px auto 3px !important;
            background-color: var(--input-bg) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            overflow: hidden !important;
            cursor: pointer !important;
            position: relative !important;
        }

        .avatar-img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            object-position: center !important;
            display: block !important;
        }

        /* 确保头像区域标题正确显示 */
        .avatar-section .section-title {
            font-size: 14px !important;
            font-weight: bold !important;
            border-bottom: 1px solid var(--border-color) !important;
            margin-bottom: 2px !important;
            padding-bottom: 2px !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        /* 打印选择模态窗口样式 */
        .print-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .print-option {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            cursor: pointer;
        }

        .print-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .print-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .print-button {
            padding: 8px 20px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .print-button:hover {
            background-color: #e0e0e0;
        }

        /* 修改第三个按钮的图标为打印图标 */
        .float-nav-button:nth-child(3) .float-nav-icon {
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z'/%3E%3C/svg%3E");
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z'/%3E%3C/svg%3E");
        }

        /* 道具页样式 */
        .items-page {
            background-color: white;
            width: 21cm;
            min-height: 29.7cm;
            margin: 10px auto;
            padding: 5px; /* 从1cm改为5px，减少内边距，与custom-page一致 */
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); /* 修改阴影效果，与custom-page一致 */
            border: 1px solid var(--border-color); /* 使用与custom-page一致的边框颜色变量 */
            box-sizing: border-box;
            position: relative;
            justify-content: flex-start; /* 内容从顶部开始排列 */
            gap: 4px; /* 添加元素间间距，与custom-page一致 */
        }

        /* 道具区域样式 */
        .items-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-top: 0; /* 移除顶部边距 */
            overflow: hidden;
            flex: 1 0 auto; /* 不收缩，占据剩余空间 */
            margin-bottom: 0; /* 移除底部边距 */
            border: 1px solid var(--border-color); /* 给整个道具区域添加边框 */
            padding: 0; /* 确保没有内边距 */
            background-color: var(--section-bg); /* 确保背景色一致 */
        }

        /* 当items-section内部的section-title需要特殊样式 */
        .items-section .section-title {
            padding: 3px 5px;
            margin: 0; /* 移除标题边距 */
            border-bottom: 1px solid var(--border-color);
        }

        /* 道具表头样式 */
        .items-header-row {
            display: grid;
            grid-template-columns: 1fr 0.6fr 2.4fr;
            gap: 0; /* 移除间隙 */
            margin-top: 0;
            margin-bottom: 0;
            background-color: #e0e0e0;
            padding: 0;
            border: none; /* 移除表头边框 */
            border-bottom: 1px solid var(--border-color); /* 只保留底部边框作为分隔线 */
        }
        
        .items-header-item {
            padding: 3px 5px;
            font-weight: bold;
            font-size: 11px;
            text-align: center;
        }

        .items-header-item:last-child {
            border-right: none;
        }

        /* 道具表头名称样式 */
        .items-header-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 道具列表样式 */
        .items-grid {
            display: flex;
            flex-direction: column;
            flex: 1;
            border: none; /* 移除列表的边框 */
            min-height: 600px; /* 添加最小高度，确保即使没有足够多的道具项，也保持一定的高度 */
            gap: 2px; /* 添加行间距 */
        }

        /* 道具项目样式 */
        .item-row {
            display: grid;
            grid-template-columns: 1fr 0.6fr 2.4fr;
            border-bottom: none; /* 移除底部边框 */
            min-height: 30px;
        }

        /* 奇偶行背景色 */
        .item-row:nth-child(odd) {
            background-color: #ffffff; /* 奇数行白色背景 */
        }

        .item-row:nth-child(even) {
            background-color: #f0f0f0; /* 偶数行灰色背景 */
        }

        .item-cell {
            padding: 5px;
            border-right: none; /* 移除右侧边框 */
            display: flex;
            align-items: center;
        }

        .item-cell:last-child {
            border-right: none;
        }

        .item-name, .item-notes {
            width: 100%;
            background-color: transparent;
            border: none;
            padding: 5px;
            font-size: 11px;
            outline: none; /* 移除输入框获得焦点时的轮廓 */
        }

        .item-name:focus, .item-notes:focus {
            background-color: transparent; /* 移除选中时的背景色 */
            box-shadow: none; /* 移除选中时的阴影 */
            outline: none; /* 确保没有轮廓 */
            border: none; /* 确保没有边框 */
        }

        /* 确保类别选择按钮也没有边框和阴影 */
        .category-select-btn {
            border: none;
            outline: none;
            box-shadow: none;
            background-color: transparent;
        }

        .category-select-btn:focus, .category-select-btn:hover {
            border: none;
            outline: none;
            box-shadow: none;
        }

        /* 道具表头标签样式 */
        .items-header-name {
            font-weight: normal;
            font-size: 11px;
            color: var(--text-color);
            text-align: center;
            width: 100%;
            padding: 2px;
        }

        /* 打印时道具页样式调整 */
        @media print {
            .items-page {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0.5cm !important;
            }
            
            .category-button {
                border: none !important;
                background: transparent !important;
            }
            
            .item-name, .item-notes {
                border: none !important;
                background: transparent !important;
            }
            
            /* 确保在打印时保持棋盘格效果 */
            .item-row:nth-child(odd) {
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .item-row:nth-child(even) {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        /* 确保所有文本使用普通字体 */
        .items-header-item, .item-cell, .item-name, .item-notes, .category-button {
            font-weight: normal;
            font-style: normal;
        }
        
        /* 优化道具栏输入框样式 - 移除所有边框 */
        .item-name, .item-notes, input[type="text"] {
            width: 100% !important;
            background-color: transparent !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            -webkit-box-shadow: none !important;
            -moz-box-shadow: none !important;
            border-radius: 0 !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            padding: 5px !important;
            font-size: 11px !important;
        }
        
        .item-name:focus, .item-notes:focus, input[type="text"]:focus,
        .item-name:hover, .item-notes:hover, input[type="text"]:hover,
        .item-name:active, .item-notes:active, input[type="text"]:active {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            -webkit-box-shadow: none !important;
            -moz-box-shadow: none !important;
            background-color: transparent !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
        }
        
        /* 确保类别选择按钮没有边框 */
        .category-select-btn, .skill-subtype-btn {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            -webkit-box-shadow: none !important;
            -moz-box-shadow: none !important;
            background-color: transparent !important;
            cursor: pointer !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
        }
        
        .category-select-btn:focus, .skill-subtype-btn:focus,
        .category-select-btn:hover, .skill-subtype-btn:hover,
        .category-select-btn:active, .skill-subtype-btn:active {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            -webkit-box-shadow: none !important;
            -moz-box-shadow: none !important;
            background-color: transparent !important;
        }
        
        /* 在打印时也确保输入框无边框 */
        @media print {
            .item-name, .item-notes, .category-select-btn, input[type="text"], .skill-subtype-btn {
                border: none !important;
                outline: none !important;
                box-shadow: none !important;
                -webkit-box-shadow: none !important;
                -moz-box-shadow: none !important;
                background-color: transparent !important;
                appearance: none !important;
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
            }
        }

        /* 战斗区域样式 */
        .combat-section {
            margin-top: 3px;
        }
        
        .combat-grid {
            display: grid;
            gap: 3px;
        }
        
        .combat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 18px; /* 确保行高与技能行一致 */
        }
        
        .combat-label {
            width: 65%; /* 进一步增加宽度比例，为更长的英文单词预留空间 */
            font-size: 11px;
            font-weight: normal; /* 改为正常字重，不加粗 */
            padding-right: 5px;
            white-space: nowrap; /* 确保文字不分行 */
            overflow: hidden; /* 防止文本溢出 */
            text-overflow: ellipsis; /* 文本溢出时显示省略号 */
        }
        
        .combat-value {
            width: 35%; /* 相应调整输入框区域的宽度 */
            display: flex;
            align-items: center;
        }
        
        .combat-input {
            width: 100%;
            padding: 2px 4px; /* 调整为与武器输入框一致的内边距 */
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 11px;
            background-color: white !important; /* 战斗区域输入框使用白色背景并强制应用 */
            min-height: 18px; /* 与技能行高度一致 */
        }
        
        /* 确保战斗区域所有输入框都使用白色背景 */
        .combat-section input,
        .combat-section .combat-input,
        #spirit, #build, #armor, #damage-bonus, #spirit-bonus {
            background-color: white !important; /* 使用!important确保覆盖其他样式 */
            border: 1px solid var(--border-color) !important;
        }

        /* 调整区域样式, 调查员区域 */
        .basic-info-section {
            padding: 10px;
            background-color: white; /* 确保整个区域是白色背景 */
        }
        
        /* 调整属性区域样式 */
        .characteristics-section {
            padding: 10px;
            background-color: white; /* 确保整个区域是白色背景 */
        }
        
        /* 直接对输入框应用白色背景 */
        .basic-info-section input[type="text"],
        .basic-info-section input[type="number"],
        .characteristics-section input[type="text"],
        .characteristics-section input[type="number"] {
            background-color: white !important;
            border: 1px solid #ddd !important;
        }

        /* 类别选择按钮样式优化 */
        .category-select-btn {
            border: none;
            outline: none;
            box-shadow: none;
            background-color: transparent;
            font-size: 10px;
            padding: 2px 4px;
            width: 100%;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .category-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            align-items: center;
        }

        .category-display {
            font-size: 10px;
            padding: 2px;
            width: 100%;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 备注输入框样式优化 */
        .item-notes {
            width: 100%;
            background-color: transparent;
            border: none;
            padding: 5px;
            font-size: 11px;
            outline: none;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 20px;
        }

        /* 优化备注单元格 */
        .item-cell:last-child {
            border-right: none;
            flex: 1;
            overflow: hidden;
        }
    </style>
    
    <!-- 添加专门处理打印时边框阴影的样式 -->
    <style>
        @media print {
            /* 使用更高优先级的选择器移除所有潜在的边框和阴影 */
            body .character-sheet .skills-section *,
            body .character-sheet .custom-skills-section * {
                border: none !important;
                box-shadow: none !important;
                -webkit-box-shadow: none !important;
                -moz-box-shadow: none !important;
                text-shadow: none !important;
                filter: none !important;
            }
            
            /* 特别处理技能行和技能项 */
            body .skill-row,
            body .custom-skill-row,
            body .skill-item,
            body .custom-skill-item,
            body .skills-header-row,
            body .skills-header-item {
                border: none !important;
                box-shadow: none !important;
                filter: none !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* 确保打印时保持棋盘格效果 */
            body .skill-row:nth-child(odd) .skill-item {
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body .skill-row:nth-child(even) .skill-item {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* 自定义技能区域打印棋盘格效果 */
            body .custom-skill-row:nth-child(odd) .custom-skill-item {
                background-color: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body .custom-skill-row:nth-child(even) .custom-skill-item {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>
    <!-- 页面标题 -->
    <div class="page-title">COC 7版人物卡</div>
    
    <!-- 加载提示框 -->
    <div class="load-dialog-overlay"></div>
    <div class="load-dialog">
        <div class="load-dialog-content">
            <p>检测到编辑过的人物卡：<span id="saved-character-name">-</span></p>
            <p>是否要载入？</p>
        </div>
        <div class="load-dialog-buttons">
            <button class="load-dialog-button" id="load-yes">载入</button>
            <button class="load-dialog-button" id="load-no">放弃</button>
        </div>
    </div>
    
    <!-- 悬浮导航按钮组 -->
    <div class="float-nav">
        <div class="float-nav-button" id="page-nav-btn" title="翻页">
            <div class="float-nav-icon"></div>
        </div>
        <div class="float-nav-button">
            <div class="float-nav-icon"></div>
        </div>
        <div class="float-nav-button">
            <div class="float-nav-icon"></div>
        </div>
        <div class="float-nav-button">
            <div class="float-nav-icon"></div>
        </div>
        <div class="float-nav-button">
            <div class="float-nav-icon"></div>
        </div>
    </div>
    
    <div class="character-sheet">
        <!-- 调查员信息 -->
        <div class="sheet-section basic-info-section">
            <div class="section-title">
                调查员 Investigator
                <div class="partner-checkbox-container">
                    <span>伙伴</span>
                    <input type="checkbox" class="partner-checkbox">
                </div>
            </div>
            <div class="field-row">
                <div class="field-label">姓名</div>
                <input type="text" class="field-input">
            </div>
            <div class="field-row">
                <div class="field-label">玩家</div>
                <input type="text" class="field-input">
            </div>
            <div class="field-row double">
                <div class="field-group">
                    <div class="field-label">时代</div>
                    <input type="text" class="field-input">
                </div>
                <div class="field-group">
                    <div class="field-label">职业</div>
                    <input type="text" class="field-input">
                </div>
            </div>
            <div class="field-row double">
                <div class="field-group">
                    <div class="field-label">年龄</div>
                    <input type="text" class="field-input">
                </div>
                <div class="field-group">
                    <div class="field-label">性别</div>
                    <input type="text" class="field-input">
                </div>
            </div>
            <div class="field-row double">
                <div class="field-group">
                    <div class="field-label">住地</div>
                    <input type="text" class="field-input">
                </div>
                <div class="field-group">
                    <div class="field-label">故乡</div>
                    <input type="text" class="field-input">
                </div>
            </div>
        </div>

        <!-- 属性 -->
        <div class="sheet-section characteristics-section">
            <div class="section-title">
                <span style="font-size: 14px !important; font-weight: bold;">属性 Characteristics</span>
                <div class="total-attr">总点数：<span id="total-attr">0</span></div>
            </div>
            <div class="characteristics-grid">
                <div class="characteristic-item">
                    <div class="char-label">力量 STR</div>
                    <input type="number" class="char-value" id="str">
                </div>
                <div class="characteristic-item">
                    <div class="char-label">体质 CON</div>
                    <input type="number" class="char-value" id="con">
                </div>
                <div class="characteristic-item">
                    <div class="char-label">敏捷 DEX</div>
                    <input type="number" class="char-value" id="dex">
                </div>
                <div class="characteristic-item">
                    <div class="char-label">外貌 APP</div>
                    <input type="number" class="char-value" id="app">
                </div>
                <div class="characteristic-item">
                    <div class="char-label">体型 SIZ</div>
                    <input type="number" class="char-value" id="siz">
                </div>
                <div class="characteristic-item">
                    <div class="char-label">教育 EDU</div>
                    <input type="number" class="char-value" id="edu">
                </div>
                <div class="characteristic-item">
                    <div class="char-label">智力 INT</div>
                    <input type="number" class="char-value" id="int">
                </div>
                <div class="characteristic-item">
                    <div class="char-label">意志 POW</div>
                    <input type="number" class="char-value" id="pow">
                </div>
                <div class="characteristic-item">
                    <div class="char-label">幸运 Luc</div>
                    <input type="number" class="char-value" id="luc">
                </div>
            </div>
        </div>

        <!-- 头像区域 -->
        <div class="sheet-section avatar-section">
            <div class="section-title">头像 Portrait</div>
            <div class="avatar-container">
                <img id="avatar-preview" class="avatar-img">
                <div class="avatar-placeholder">
                    <div class="avatar-placeholder-icon">📷</div>
                    <div class="avatar-placeholder-text">点击上传头像</div>
                </div>
            </div>
            <input type="file" id="avatar-upload" accept="image/*" class="hidden-file-input">
        </div>

        <!-- 属性状态区 -->
        <div class="sheet-section stats-section">
            <div class="section-title">角色状态 Status</div>
            <div class="stats-container">
                <!-- 理智值 -->
                <div class="stat-box">
                    <div class="stat-title">理智值 SAN</div>
                    <div class="stat-content">
                        <div class="stat-item">
                            <div class="stat-label">当前 Current</div>
                            <input type="number" class="stat-value" id="current-san" maxlength="2">
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">起始 Start</div>
                            <input type="number" class="stat-value" id="start-san" maxlength="2">
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">最大 Max</div>
                            <input type="number" class="stat-value" id="max-san" maxlength="2">
                        </div>
                    </div>
                </div>
                
                <!-- 生命值 -->
                <div class="stat-box">
                    <div class="stat-title">生命值 HP</div>
                    <div class="stat-content">
                        <div class="stat-item">
                            <div class="stat-label">当前 Current</div>
                            <input type="number" class="stat-value" id="current-hp" maxlength="2">
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">最大 Max</div>
                            <input type="number" class="stat-value" id="max-hp" maxlength="2">
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">临时 Temp</div>
                            <input type="number" class="stat-value" id="temp-hp" maxlength="2">
                        </div>
                    </div>
                </div>
                
                <!-- 魔法值 -->
                <div class="stat-box">
                    <div class="stat-title">魔法值 MP</div>
                    <div class="stat-content">
                        <div class="stat-item">
                            <div class="stat-label">当前 Current</div>
                            <input type="number" class="stat-value" id="current-mp" maxlength="2">
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">最大 Max</div>
                            <input type="number" class="stat-value" id="max-mp" maxlength="2">
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">临时 Temp</div>
                            <input type="number" class="stat-value" id="temp-mp" maxlength="2">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 技能区域 -->
        <div class="sheet-section skills-section">
            <div class="section-title" style="margin-bottom: 0; padding-bottom: 1px; white-space: nowrap !important;">
                <span style="font-size: 14px !important; font-weight: bold; white-space: nowrap !important;">技能 Skills</span>
                <div class="skills-header" style="margin-bottom: 0; padding-bottom: 0; flex-wrap: nowrap; white-space: nowrap;">
                    <div class="points-container" style="padding: 0; white-space: nowrap; flex-shrink: 0;">
                        <div class="points-label" style="white-space: nowrap;">职业点数</div>
                        <input type="text" class="points-input" id="occupation-points" maxlength="3">
                        <div class="points-remaining" style="white-space: nowrap; display: flex; align-items: center;">剩余:&nbsp;<span id="occupation-remaining">0</span></div>
                    </div>
                    <div class="points-container" style="padding: 0; white-space: nowrap; flex-shrink: 0;">
                        <div class="points-label" style="white-space: nowrap;">兴趣点数</div>
                        <input type="text" class="points-input" id="interest-points" maxlength="3">
                        <div class="points-remaining" style="white-space: nowrap; display: flex; align-items: center;">剩余:&nbsp;<span id="interest-remaining">0</span></div>
                    </div>
                </div>
            </div>
            
            <div class="skills-header-row">
                <div class="skills-header-item">
                    <div class="skills-header-name">技能名</div>
                    <div class="skills-header-points">
                        <div class="skills-header-base">基础</div>
                        <div class="skills-header-occupation">职业</div>
                        <div class="skills-header-interest">兴趣</div>
                        <div class="skills-header-growth">成长</div>
                    </div>
                    <div class="skills-header-total">
                        <div class="skills-header-success">成功</div>
                        <div class="skills-header-success">困难</div>
                        <div class="skills-header-success">极难</div>
                    </div>
                </div>
                <div class="skills-header-item">
                    <div class="skills-header-name">技能名</div>
                    <div class="skills-header-points">
                        <div class="skills-header-base">基础</div>
                        <div class="skills-header-occupation">职业</div>
                        <div class="skills-header-interest">兴趣</div>
                        <div class="skills-header-growth">成长</div>
                    </div>
                    <div class="skills-header-total">
                        <div class="skills-header-success">成功</div>
                        <div class="skills-header-success">困难</div>
                        <div class="skills-header-success">极难</div>
                    </div>
                </div>
            </div>
            
            <div class="skills-grid" id="skills-container">
                <!-- 技能列表将由JavaScript动态生成 -->
            </div>
        </div>
        
        <!-- 武器区域 -->
        <div class="sheet-section weapon-section">
            <div class="section-title">
                <span style="font-size: 14px !important; font-weight: bold; white-space: nowrap !important;">武器 Weapon</span>
            </div>
            
            <div class="weapon-header-row">
                <div class="weapon-header-item weapon-name">武器名称</div>
                <div class="weapon-header-item weapon-damage">伤害</div>
                <div class="weapon-header-item weapon-feature">特性</div>
            </div>
            
            <div class="weapon-grid">
                <!-- 武器行1 -->
                <div class="weapon-row">
                    <div class="weapon-name">
                        <div class="weapon-name-text"></div>
                        <input type="text" class="weapon-name-input" placeholder="输入武器名称">
                    </div>
                    <div class="weapon-damage">
                        <div class="weapon-damage-text"></div>
                        <input type="text" class="weapon-damage-input" placeholder="输入伤害值">
                    </div>
                    <div class="weapon-feature">
                        <div class="weapon-feature-text"></div>
                        <input type="text" class="weapon-feature-input" placeholder="输入特性">
                    </div>
                </div>
                
                <!-- 武器行2 -->
                <div class="weapon-row">
                    <div class="weapon-name">
                        <div class="weapon-name-text"></div>
                        <input type="text" class="weapon-name-input" placeholder="输入武器名称">
                    </div>
                    <div class="weapon-damage">
                        <div class="weapon-damage-text"></div>
                        <input type="text" class="weapon-damage-input" placeholder="输入伤害值">
                    </div>
                    <div class="weapon-feature">
                        <div class="weapon-feature-text"></div>
                        <input type="text" class="weapon-feature-input" placeholder="输入特性">
                    </div>
                </div>
                
                <!-- 武器行3 -->
                <div class="weapon-row">
                    <div class="weapon-name">
                        <div class="weapon-name-text"></div>
                        <input type="text" class="weapon-name-input" placeholder="输入武器名称">
                    </div>
                    <div class="weapon-damage">
                        <div class="weapon-damage-text"></div>
                        <input type="text" class="weapon-damage-input" placeholder="输入伤害值">
                    </div>
                    <div class="weapon-feature">
                        <div class="weapon-feature-text"></div>
                        <input type="text" class="weapon-feature-input" placeholder="输入特性">
                    </div>
                </div>
                
                <!-- 武器行4 -->
                <div class="weapon-row">
                    <div class="weapon-name">
                        <div class="weapon-name-text"></div>
                        <input type="text" class="weapon-name-input" placeholder="输入武器名称">
                    </div>
                    <div class="weapon-damage">
                        <div class="weapon-damage-text"></div>
                        <input type="text" class="weapon-damage-input" placeholder="输入伤害值">
                    </div>
                    <div class="weapon-feature">
                        <div class="weapon-feature-text"></div>
                        <input type="text" class="weapon-feature-input" placeholder="输入特性">
                    </div>
                </div>
                
                <!-- 武器行5 -->
                <div class="weapon-row">
                    <div class="weapon-name">
                        <div class="weapon-name-text"></div>
                        <input type="text" class="weapon-name-input" placeholder="输入武器名称">
                    </div>
                    <div class="weapon-damage">
                        <div class="weapon-damage-text"></div>
                        <input type="text" class="weapon-damage-input" placeholder="输入伤害值">
                    </div>
                    <div class="weapon-feature">
                        <div class="weapon-feature-text"></div>
                        <input type="text" class="weapon-feature-input" placeholder="输入特性">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 战斗区域 -->
        <div class="sheet-section combat-section">
            <div class="section-title">
                <span style="font-size: 14px !important; font-weight: bold; white-space: nowrap !important;">战斗 Combat</span>
            </div>
            
            <div class="combat-grid">
                <!-- 伤害加值 -->
                <div class="combat-row">
                    <div class="combat-label" title="伤害加值 Damage Bonus">伤害加值 Damage Bonus</div>
                    <div class="combat-value">
                        <input type="text" class="combat-input" id="damage-bonus" maxlength="5" readonly>
                    </div>
                </div>
                
                <!-- 精神加值 -->
                <div class="combat-row">
                    <div class="combat-label" title="精神加值 Spirit Bonus">精神加值 Spirit Bonus</div>
                    <div class="combat-value">
                        <input type="text" class="combat-input" id="spirit-bonus" maxlength="5" readonly>
                    </div>
                </div>
                
                <!-- 体格 -->
                <div class="combat-row">
                    <div class="combat-label" title="体格 Build">体格 Build</div>
                    <div class="combat-value">
                        <input type="text" class="combat-input" id="build" maxlength="3" readonly>
                    </div>
                </div>
                
                <!-- 护甲 -->
                <div class="combat-row">
                    <div class="combat-label" title="护甲 Armor">护甲 Armor</div>
                    <div class="combat-value">
                        <input type="number" class="combat-input" id="armor" maxlength="3" min="0" max="999">
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 子技能选择模态窗口 -->
    <div id="subtype-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">选择子技能</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="subtype-list" class="subtype-list"></div>
            </div>
        </div>
    </div>

    <!-- 道具类别选择模态窗口 -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">选择道具类别</h3>
                <span class="close-category-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="category-list" class="subtype-list"></div>
            </div>
        </div>
    </div>

    <!-- 分页符 - 专门设计为不产生空白页 -->
    <div class="page-break" style="display:none; height:0; margin:0; padding:0; position:absolute; visibility:hidden;"></div>

    <!-- 自定义技能页 -->
    <div class="custom-page">
        <!-- 调查员引用区域 -->
        <div class="investigator-reference">
            <div class="section-title">
                调查员 Investigator
            </div>
            <div class="investigator-info">
                <div class="investigator-data">
                    <div class="investigator-field">
                        <div class="investigator-label">姓名:</div>
                        <div class="investigator-value" id="ref-name">-</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 自定义技能区域 -->
        <div class="sheet-section custom-skills-section">
            <div class="section-title">
                <span style="font-size: 14px !important; font-weight: bold; white-space: nowrap !important;">自定义技能 Custom Skills</span>
            </div>
            
            <div class="skills-header-row">
                <div class="skills-header-item">
                    <div class="skills-header-name">技能名</div>
                    <div class="skills-header-points">
                        <div class="skills-header-base">基础</div>
                        <div class="skills-header-occupation">职业</div>
                        <div class="skills-header-interest">兴趣</div>
                        <div class="skills-header-growth">成长</div>
                    </div>
                    <div class="skills-header-total">
                        <div class="skills-header-success">成功</div>
                        <div class="skills-header-success">困难</div>
                        <div class="skills-header-success">极难</div>
                    </div>
                </div>
                <div class="skills-header-item">
                    <div class="skills-header-name">技能名</div>
                    <div class="skills-header-points">
                        <div class="skills-header-base">基础</div>
                        <div class="skills-header-occupation">职业</div>
                        <div class="skills-header-interest">兴趣</div>
                        <div class="skills-header-growth">成长</div>
                    </div>
                    <div class="skills-header-total">
                        <div class="skills-header-success">成功</div>
                        <div class="skills-header-success">困难</div>
                        <div class="skills-header-success">极难</div>
                    </div>
                </div>
            </div>
            
            <div class="custom-skills-grid" id="custom-skills-container">
                <!-- 动态生成20行自定义技能 -->
            </div>
        </div>
    </div>

    <!-- 道具页 -->
    <div class="items-page">
        <!-- 调查员引用区域 -->
        <div class="investigator-reference">
            <div class="section-title">
                调查员 Investigator
            </div>
            <div class="investigator-info">
                <div class="investigator-data">
                    <div class="investigator-field">
                        <div class="investigator-label">姓名:</div>
                        <div class="investigator-value" id="ref-name-items">-</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 道具区域 -->
        <div class="sheet-section items-section">
            <div class="section-title">
                <span style="font-size: 14px !important; font-weight: bold; white-space: nowrap !important;">道具 Items</span>
            </div>
            
            <div class="items-header-row">
                <div class="items-header-item">
                    <div class="items-header-name">名称 Name</div>
                </div>
                <div class="items-header-item">
                    <div class="items-header-name">类别 Category</div>
                </div>
                <div class="items-header-item">
                    <div class="items-header-name">备注/描述 Notes</div>
                </div>
            </div>
            
            <div class="items-grid" id="items-container">
                <!-- 动态生成道具记录 -->
            </div>
        </div>
    </div>

    <!-- 加载提示框 -->
    <div class="load-dialog-overlay"></div>
    <div class="load-dialog">
        <div class="load-dialog-content">
            <p>检测到编辑过的人物卡：<span id="saved-character-name">-</span></p>
            <p>是否要载入？</p>
        </div>
        <div class="load-dialog-buttons">
            <button class="load-dialog-button" id="load-yes">载入</button>
            <button class="load-dialog-button" id="load-no">放弃</button>
        </div>
    </div>

    <!-- 打印选择模态窗口 -->
    <div id="print-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">选择要打印的页面</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="print-options">
                    <label class="print-option">
                        <input type="checkbox" id="print-main" checked>
                        主页面（基本信息、属性、技能等）
                    </label>
                    <label class="print-option">
                        <input type="checkbox" id="print-custom">
                        自定义技能页面
                    </label>
                    <label class="print-option">
                        <input type="checkbox" id="print-items">
                        道具页面
                    </label>
                </div>
                <div class="print-buttons">
                    <button id="confirm-print" class="print-button">开始打印</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* 打印选择模态窗口样式 */
        .print-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .print-option {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            cursor: pointer;
        }

        .print-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .print-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .print-button {
            padding: 8px 20px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .print-button:hover {
            background-color: #e0e0e0;
        }

        /* 修改第三个按钮的图标为打印图标 */
        .float-nav-button:nth-child(3) .float-nav-icon {
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z'/%3E%3C/svg%3E");
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z'/%3E%3C/svg%3E");
        }
    </style>

    <script>
        // 计算剩余点数函数 - 移到全局作用域
        function calculateRemainingPoints() {
            try {
                // 获取总点数
                const totalOccupation = parseInt(document.getElementById('occupation-points').value || 0);
                const totalInterest = parseInt(document.getElementById('interest-points').value || 0);
                
                // 计算已使用的点数
                let occupationUsed = 0;
                let interestUsed = 0;

                // 计算普通技能已使用的点数
                document.querySelectorAll('.skill-item').forEach(item => {
                    const occInput = item.querySelector('.occupation-points');
                    const intInput = item.querySelector('.interest-points');
                    
                    occupationUsed += parseInt(occInput?.value || 0);
                    interestUsed += parseInt(intInput?.value || 0);
                });

                // 计算自定义技能已使用的点数
                document.querySelectorAll('.custom-skill-item').forEach(item => {
                    const occInput = item.querySelector('.custom-occupation-points');
                    const intInput = item.querySelector('.custom-interest-points');
                    
                    occupationUsed += parseInt(occInput?.value || 0);
                    interestUsed += parseInt(intInput?.value || 0);
                });

                // 更新显示剩余点数
                document.getElementById('occupation-remaining').textContent = totalOccupation - occupationUsed;
                document.getElementById('interest-remaining').textContent = totalInterest - interestUsed;
            } catch (error) {
                console.error('计算剩余点数时出错:', error);
            }
        }

        // 添加非负整数验证函数
        function validateNonNegativeInteger(input) {
            const value = input.value.trim();
            // 允许空值
            if (value === '') {
                return;
            }
            // 检查是否为非负整数
            const parsedValue = parseInt(value, 10);
            if (isNaN(parsedValue) || parsedValue < 0 || parsedValue.toString() !== value) {
                // 输入无效，重置为0或空值
                input.value = input.dataset.lastValidValue || '';
            } else {
                // 保存有效值
                input.dataset.lastValidValue = parsedValue.toString();
            }
        }

        // 添加更新闪避值函数
        function updateDodgeValue() {
            try {
                // 获取敏捷值，默认为0
                const dexInput = document.getElementById('dex');
                const dexValue = parseInt(dexInput?.value || 0);
                const dodgeBase = Math.floor(dexValue / 2);
                
                // 查找闪避技能并更新基础值
                document.querySelectorAll('.skill-item').forEach(item => {
                    if (item.dataset.skillName === "闪避") {
                        const baseElement = item.querySelector('.skill-base');
                        if (baseElement) {
                            baseElement.textContent = dodgeBase;
                            // 更新数据属性，用于打印时控制显示
                            baseElement.dataset.zero = dodgeBase === 0 ? "true" : "false";
                            // 触发重新计算总值
                            const inputs = item.querySelectorAll('.skill-point-input');
                            inputs.forEach(input => {
                                if (input) {
                                    const event = new Event('input', { bubbles: true });
                                    input.dispatchEvent(event);
                                }
                            });
                        }
                    }
                });
            } catch (error) {
                console.error('更新闪避值时出错:', error);
            }
        }

        // 技能数据
        const skillsData = [
            { name: "信用评级", base: 0 },
            { name: "克苏鲁神话", base: 0 },
            { name: "侦查", base: 25 },
            { name: "聆听", base: 20 },
            { name: "图书馆使用", base: 20 },
            { name: "计算机使用", base: 5 },
            { name: "潜行", base: 20 },
            { name: "追踪", base: 10 },
            { name: "导航", base: 10 },
            { name: "话术", base: 5 },
            { name: "说服", base: 10 },
            { name: "取悦", base: 15 },
            { name: "恐吓", base: 15 },
            { name: "心理学", base: 10 },
            { name: "母语", base: "edu", subtypes: ["汉语", "英语", "日语", "法语", "俄语", "德语", "韩语", "粤语", "拉丁语", "荷兰语", "挪威语", "丹麦", "印度语", "西班牙语", "葡萄牙语", "阿拉伯语"], rows: 1 },
            { name: "外语", base: 1, subtypes: ["汉语", "英语", "日语", "法语", "俄语", "德语", "韩语", "粤语", "拉丁语", "荷兰语", "挪威语", "丹麦", "印度语", "西班牙语", "葡萄牙语", "阿拉伯语"], rows: 2 },
            { name: "闪避", base: "halfDex" },
            { name: "格斗", base: -1, subtypes: [
                { name: "斗殴", base: 25 },
                { name: "链锯", base: 10 },
                { name: "刀剑", base: 20 },
                { name: "矛", base: 20 },
                { name: "斧", base: 15 },
                { name: "绞索", base: 15 },
                { name: "链枷", base: 10 },
                { name: "鞭", base: 5 }
            ], rows: 3 },
            { name: "射击", base: -1, subtypes: [
                { name: "手枪", base: 20 },
                { name: "步枪/霰弹枪", base: 25 },
                { name: "冲锋枪", base: 15 },
                { name: "弓弩", base: 15 },
                { name: "机枪", base: 10 },
                { name: "重武器", base: 10 }
            ], rows: 3 },
            { name: "投掷", base: 20 },
            { name: "急救", base: 30 },
            { name: "医学", base: 1 },
            { name: "精神分析", base: 1 },
            { name: "攀爬", base: 20 },
            { name: "跳跃", base: 20 },
            { name: "游泳", base: 20 },
            { name: "博物学", base: 10 },
            { name: "神秘学", base: 5 },
            { name: "考古学", base: 1 },
            { name: "人类学", base: 1 },
            { name: "估价", base: 5 },
            { name: "会计", base: 5 },
            { name: "法律", base: 5 },
            { name: "历史", base: 5 },
            { name: "电子学", base: 1 },
            { name: "科学", base: -1, subtypes: [
                { name: "数学", base: 10 },
                { name: "地质学", base: 1 },
                { name: "化学", base: 1 },
                { name: "生物学", base: 1 },
                { name: "天文学", base: 1 },
                { name: "物理", base: 1 },
                { name: "药学", base: 1 },
                { name: "植物学", base: 1 },
                { name: "动物学", base: 1 },
                { name: "密码学", base: 1 },
                { name: "工程学", base: 1 },
                { name: "气象学", base: 1 },
                { name: "鉴证", base: 1 }
            ], rows: 3 },
            { name: "乔装", base: 5 },
            { name: "妙手", base: 10 },
            { name: "锁匠", base: 1 },
            { name: "机械维修", base: 10 },
            { name: "电气维修", base: 10 },
            { name: "驯兽", base: 5 },
            { name: "技艺", base: -1, subtypes: [
                { name: "表演", base: 5 },
                { name: "音乐", base: 5 },
                { name: "绘画", base: 5 },
                { name: "艺术", base: 5 },
                { name: "摄影", base: 5 },
                { name: "写作", base: 5 },
                { name: "书法", base: 5 },
                { name: "打字", base: 5 },
                { name: "速记", base: 5 },
                { name: "伪造", base: 5 },
                { name: "烹饪", base: 5 },
                { name: "裁缝", base: 5 },
                { name: "理发", base: 5 },
                { name: "技术制图", base: 5 },
                { name: "耕作", base: 5 },
                { name: "木工", base: 5 },
                { name: "铁匠", base: 5 },
                { name: "焊接", base: 5 },
                { name: "管道工", base: 5 }
            ], rows: 3 },
            { name: "生存", base: -1, subtypes: [
                { name: "沙漠", base: 5 },
                { name: "森林", base: 5 },
                { name: "荒岛", base: 5 },
                { name: "高山", base: 5 },
                { name: "海上", base: 5 }
            ], rows: 3 },
            { name: "汽车驾驶", base: 20 },
            { name: "骑术", base: 5 },
            { name: "操作重型机械", base: 1 },
            { name: "驾驶", base: -1, subtypes: [
                { name: "船", base: 1 },
                { name: "马车", base: 1 },
                { name: "飞行器", base: 25 }
            ], rows: 1 }
        ];

        // 计算属性总值的函数
        function calculateTotalAttr() {
            const attrInputs = [
                document.getElementById('str'),
                document.getElementById('con'),
                document.getElementById('dex'),
                document.getElementById('app'),
                document.getElementById('siz'),
                document.getElementById('edu'),
                document.getElementById('int'),
                document.getElementById('pow'),
                document.getElementById('luc')
            ];
            
            let total = 0;
            attrInputs.forEach(input => {
                total += parseInt(input.value || 0);
            });
            
            const totalAttr = document.getElementById('total-attr');
            if (totalAttr) {
                totalAttr.textContent = total;
            }
            
            // 更新闪避值（敏捷的一半）
            updateDodgeValue();
            
            // 计算伤害加值
            calculateDamageBonus();
            
            // 计算精神加值
            calculateSpiritBonus();
            
            // 计算体格
            calculateBuild();
        }

        // DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 非负整数校验函数
            function validateNonNegativeInteger(input) {
                const value = input.value.trim();
                // 允许空值
                if (value === '') {
                    return;
                }
                // 检查是否为非负整数
                const parsedValue = parseInt(value, 10);
                if (isNaN(parsedValue) || parsedValue < 0 || parsedValue.toString() !== value) {
                    // 输入无效，重置为0或空值
                    input.value = input.dataset.lastValidValue || '';
                } else {
                    // 保存有效值
                    input.dataset.lastValidValue = parsedValue.toString();
                }
            }
            
            // 为所有数字输入框添加校验
            function applyValidation() {
                const numberInputs = document.querySelectorAll('input[type="number"]');
                numberInputs.forEach(input => {
                    // 更改为文本输入框
                    input.type = 'text';
                    
                    // 添加输入验证
                    input.addEventListener('input', function() {
                        validateNonNegativeInteger(this);
                    });
                    
                    // 在失焦时再次验证
                    input.addEventListener('blur', function() {
                        validateNonNegativeInteger(this);
                        // 触发其他可能的事件监听器
                        if (this.classList.contains('skill-point-input') || 
                            this.classList.contains('char-value')) {
                            this.dispatchEvent(new Event('input'));
                        }
                    });
                });
            }
            
            // 应用输入验证
            applyValidation();
            
            // 初始化技能列表后立即计算一次闪避值
            setTimeout(function() {
                updateDodgeValue();
                // 初始化所有成功等级的数据属性
                document.querySelectorAll('.skill-result').forEach(result => {
                    if (result.textContent === '0' || result.textContent === '') {
                        result.dataset.filled = "false";
                    } else {
                        result.dataset.filled = "true";
                    }
                });
                
                // 应用列交替风格
                applyColumnStyles();
            }, 100);
            
            // 添加应用列样式的函数
            function applyColumnStyles() {
                // 为每行添加奇偶行标记类
                document.querySelectorAll('.skill-row').forEach((row, rowIndex) => {
                    // 移除可能已存在的类
                    row.classList.remove('odd-row', 'even-row');
                    
                    // 添加奇偶行标记类
                    if (rowIndex % 2 === 0) {
                        row.classList.add('even-row');
                    } else {
                        row.classList.add('odd-row');
                    }
                    
                    // 为每个单元格添加列标记类
                    const cells = row.querySelectorAll('.skill-item');
                    if (cells.length > 0) {
                        cells[0].classList.remove('left-column-cell', 'right-column-cell');
                        cells[0].classList.add('left-column-cell');
                        
                        if (cells[1]) {
                            cells[1].classList.remove('left-column-cell', 'right-column-cell');
                            cells[1].classList.add('right-column-cell');
                        }
                    }
                });
            }
            
            // 添加打印前处理函数
            window.addEventListener('beforeprint', function() {
                // 隐藏未选择值的下拉菜单
                document.querySelectorAll('select.skill-subtype').forEach(select => {
                    if (select.value === '' || select.value === 'custom') {
                        select.classList.add('empty-select');
                    }
                });
                
                // 标记为0的技能基础值 - 确保显示"0"且不会被隐藏
                document.querySelectorAll('.skill-base').forEach(base => {
                    if (base.textContent === '' || base.textContent === '0') {
                        base.dataset.zero = "true";
                        // 确保空值显示为"0"
                        if (base.textContent === '') {
                            base.textContent = "0";
                        }
                        // 确保一定可见
                        base.style.visibility = 'visible';
                        base.style.color = 'var(--text-color)';
                    } else {
                        base.dataset.zero = "false";
                    }
                    // 让CSS规则决定背景色
                    base.style.backgroundColor = 'var(--section-bg)';
                });
                
                // 标记未填写的成功等级 - 确保显示"0"且不会被隐藏
                document.querySelectorAll('.skill-result').forEach(result => {
                    if (result.textContent === '' || result.textContent === '0') {
                        result.dataset.filled = "false";
                        // 确保空值显示为"0"
                        if (result.textContent === '') {
                            result.textContent = "0";
                        }
                        // 确保一定可见
                        result.style.visibility = 'visible';
                        result.style.color = 'var(--text-color)';
                    } else {
                        result.dataset.filled = "true";
                    }
                    // 让CSS规则决定背景色
                    result.style.backgroundColor = 'var(--section-bg)';
                });
                
                // 确保棋盘格类名正确应用
                document.querySelectorAll('.skill-row').forEach((row, rowIndex) => {
                    // 添加奇偶行标记类
                    row.classList.remove('odd-row', 'even-row');
                    if (rowIndex % 2 === 0) {
                        row.classList.add('even-row');
                    } else {
                        row.classList.add('odd-row');
                    }
                    
                    // 为每个单元格添加列标记类并确保样式正确
                    const cells = row.querySelectorAll('.skill-item');
                    if (cells.length > 0) {
                        cells[0].classList.remove('left-column-cell', 'right-column-cell');
                        cells[0].classList.add('left-column-cell');
                        
                        if (cells[1]) {
                            cells[1].classList.remove('left-column-cell', 'right-column-cell');
                            cells[1].classList.add('right-column-cell');
                        }
                    }
                    
                    // 特殊处理：强制设置单元格样式以确保棋盘格效果
                    cells.forEach(cell => {
                        // 保留可见性属性，但确保内容可见
                        if (cell.style.visibility === 'hidden') {
                            cell.style.visibility = 'visible';
                            cell.style.color = 'transparent';
                        } else {
                            cell.style.visibility = 'visible';
                            cell.style.color = 'var(--text-color)';
                        }
                        
                        // 移除任何可能冲突的背景色样式
                        cell.style.removeProperty('background-color');
                    });
                });
                
                // 添加强制打印颜色属性到body元素
                document.body.setAttribute('style', 
                    'print-color-adjust: exact !important; -webkit-print-color-adjust: exact !important; color-adjust: exact !important;');
                
                // 强制浏览器渲染样式变化
                document.body.offsetHeight;
            });
            
            // 打印后恢复下拉菜单显示
            window.addEventListener('afterprint', function() {
                document.querySelectorAll('select.skill-subtype').forEach(select => {
                    select.classList.remove('empty-select');
                });
                
                // 恢复空值的显示（可选，如果需要在打印后恢复空白显示）
                /*
                document.querySelectorAll('.skill-base[data-zero="true"]').forEach(base => {
                    if (base.textContent === "0") {
                        base.textContent = "";
                    }
                });
                
                document.querySelectorAll('.skill-result[data-filled="false"]').forEach(result => {
                    if (result.textContent === "0") {
                        result.textContent = "";
                    }
                });
                */
            });
            
            // 初始化头像上传功能
            const avatarUpload = document.getElementById('avatar-upload');
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarContainer = document.querySelector('.avatar-container');
            const avatarPlaceholder = document.querySelector('.avatar-placeholder');
            
            // 点击头像容器触发文件选择
            avatarContainer.addEventListener('click', function() {
                avatarUpload.click();
            });
            
            avatarUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        avatarPreview.src = event.target.result;
                        // 有图片后隐藏占位符
                        avatarPlaceholder.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // 检查是否有预设头像
            avatarPreview.addEventListener('load', function() {
                if (avatarPreview.src && avatarPreview.src !== window.location.href) {
                    avatarPlaceholder.style.display = 'none';
                }
            });

            // 初始化属性计算
            const strInput = document.getElementById('str');
            const conInput = document.getElementById('con');
            const dexInput = document.getElementById('dex');
            const appInput = document.getElementById('app');
            const sizInput = document.getElementById('siz');
            const eduInput = document.getElementById('edu');
            const intInput = document.getElementById('int');
            const powInput = document.getElementById('pow');
            const lucInput = document.getElementById('luc');
            const totalAttr = document.getElementById('total-attr');
            
            const attrInputs = [strInput, conInput, dexInput, appInput, sizInput, eduInput, intInput, powInput, lucInput];
            
            attrInputs.forEach(input => {
                input.addEventListener('input', calculateTotalAttr);
            });
            
            function updateDodgeValue() {
                // 确保在敏捷值未填写时默认为0
                const dexValue = parseInt(dexInput.value || 0);
                const dodgeBase = Math.floor(dexValue / 2);
                
                // 查找闪避技能并更新基础值
                document.querySelectorAll('.skill-item').forEach(item => {
                    if (item.dataset.skillName === "闪避") {
                        const baseElement = item.querySelector('.skill-base');
                        if (baseElement) {
                            baseElement.textContent = dodgeBase;
                            // 更新数据属性，用于打印时控制显示
                            baseElement.dataset.zero = dodgeBase === 0 ? "true" : "false";
                            // 触发重新计算总值
                            const inputs = item.querySelectorAll('.skill-point-input');
                            inputs.forEach(input => {
                                input.dispatchEvent(new Event('input'));
                            });
                        }
                    }
                });
            }

            // 生成技能列表
            const skillsContainer = document.getElementById('skills-container');
            
            // 职业点数和兴趣点数计算
            const occupationPoints = document.getElementById('occupation-points');
            const interestPoints = document.getElementById('interest-points');
            const occupationRemaining = document.getElementById('occupation-remaining');
            const interestRemaining = document.getElementById('interest-remaining');
            
            // 添加事件监听器
            occupationPoints.addEventListener('input', calculateRemainingPoints);
            interestPoints.addEventListener('input', calculateRemainingPoints);
            
            // 创建技能项函数
            function createSkillItem(skill) {
                const skillItem = document.createElement('div');
                skillItem.className = 'skill-item';
                
                skillItem.dataset.skillName = skill.name;
                
                // 职业技能复选框
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'skill-checkbox';
                skillItem.appendChild(checkbox);
                
                // 技能名称
                const nameContainer = document.createElement('div');
                nameContainer.className = 'skill-name';
                
                const nameText = document.createElement('div');
                nameText.className = 'skill-name-text';
                nameText.textContent = skill.name;
                nameContainer.appendChild(nameText);
                
                // 添加子技能选择（如果有）
                if (skill.subtypes && Array.isArray(skill.subtypes) && !skill.subtypes[0].name) {
                    // 创建选择按钮
                    const selectBtn = document.createElement('div');
                    selectBtn.className = 'skill-subtype-btn';
                    selectBtn.textContent = '选择...';
                    selectBtn.dataset.skillName = skill.name;
                    selectBtn.addEventListener('click', function() {
                        openSubtypeModal(skill, this);
                    });
                    
                    // 创建选中后的显示区域
                    const subtypeDisplay = document.createElement('span');
                    subtypeDisplay.className = 'skill-subtype-display';
                    subtypeDisplay.style.display = 'none';
                    
                    nameContainer.appendChild(selectBtn);
                    nameContainer.appendChild(subtypeDisplay);
                }
                
                skillItem.appendChild(nameContainer);
                
                // 基础值和点数分配
                const pointsContainer = document.createElement('div');
                pointsContainer.className = 'skill-points';
                
                // 基础值
                const baseValue = document.createElement('div');
                baseValue.className = 'skill-base';
                
                // 处理特殊基础值
                if (skill.base === "halfDex") {
                    const dexValue = parseInt(document.getElementById('dex').value || 0);
                    baseValue.textContent = Math.floor(dexValue / 2);
                } else if (skill.base === "edu") {
                    // 初始时母语显示基础值为0，不从教育值获取
                    baseValue.textContent = '0';
                    // 设置特殊标识，以便后续更新，但初始不激活
                    baseValue.dataset.baseType = "edu-inactive";
                } else {
                    baseValue.textContent = skill.base;
                }
                
                pointsContainer.appendChild(baseValue);
                
                // 职业点数
                const occPoints = document.createElement('input');
                occPoints.type = 'text';
                occPoints.className = 'skill-point-input occupation-points';
                occPoints.dataset.min = 0;
                occPoints.maxLength = 3; // 限制最多输入3位数字
                occPoints.addEventListener('input', function() {
                    validateNonNegativeInteger(this);
                });
                occPoints.addEventListener('blur', function() {
                    validateNonNegativeInteger(this);
                });
                pointsContainer.appendChild(occPoints);
                
                // 兴趣点数
                const intPoints = document.createElement('input');
                intPoints.type = 'text';
                intPoints.className = 'skill-point-input interest-points';
                intPoints.dataset.min = 0;
                intPoints.maxLength = 3; // 限制最多输入3位数字
                intPoints.addEventListener('input', function() {
                    validateNonNegativeInteger(this);
                });
                intPoints.addEventListener('blur', function() {
                    validateNonNegativeInteger(this);
                });
                pointsContainer.appendChild(intPoints);
                
                // 成长点数
                const growthPoints = document.createElement('input');
                growthPoints.type = 'text';
                growthPoints.className = 'skill-point-input growth-points';
                growthPoints.dataset.min = 0;
                growthPoints.maxLength = 3; // 限制最多输入3位数字
                growthPoints.addEventListener('input', function() {
                    validateNonNegativeInteger(this);
                });
                growthPoints.addEventListener('blur', function() {
                    validateNonNegativeInteger(this);
                });
                pointsContainer.appendChild(growthPoints);
                
                skillItem.appendChild(pointsContainer);
                
                // 成功率
                const totalContainer = document.createElement('div');
                totalContainer.className = 'skill-total';
                
                // 常规成功
                const regularSuccess = document.createElement('div');
                regularSuccess.className = 'skill-result regular-success';
                
                // 困难成功
                const hardSuccess = document.createElement('div');
                hardSuccess.className = 'skill-result hard-success';
                
                // 极难成功
                const extremeSuccess = document.createElement('div');
                extremeSuccess.className = 'skill-result extreme-success';
                
                // 设置初始成功率值
                if (skill.base === "edu") {
                    // 母语技能初始显示基础值为0
                    regularSuccess.textContent = '0';
                    hardSuccess.textContent = '0';
                    extremeSuccess.textContent = '0';
                    
                    // 设置已填充标记
                    regularSuccess.dataset.filled = "true";
                    hardSuccess.dataset.filled = "true";
                    extremeSuccess.dataset.filled = "true";
                } else {
                    regularSuccess.textContent = skill.base;
                    hardSuccess.textContent = Math.floor(skill.base / 2);
                    extremeSuccess.textContent = Math.floor(skill.base / 5);
                    
                    // 设置已填充标记
                    if (skill.base > 0) regularSuccess.dataset.filled = "true";
                    if (Math.floor(skill.base / 2) > 0) hardSuccess.dataset.filled = "true";
                    if (Math.floor(skill.base / 5) > 0) extremeSuccess.dataset.filled = "true";
                }
                
                totalContainer.appendChild(regularSuccess);
                totalContainer.appendChild(hardSuccess);
                totalContainer.appendChild(extremeSuccess);
                
                skillItem.appendChild(totalContainer);
                
                // 添加点数变更监听器
                const pointInputs = [occPoints, intPoints, growthPoints];
                pointInputs.forEach(input => {
                    input.addEventListener('input', function() {
                        // 计算总值
                        const base = skill.base === "halfDex" 
                            ? Math.floor(parseInt(document.getElementById('dex').value || 0) / 2)
                            : skill.base === "edu"
                            ? (baseValue.dataset.baseType === "edu-active" 
                               ? (document.getElementById('edu').value ? parseInt(document.getElementById('edu').value) : 0)
                               : 0)
                            : (typeof skill.base === 'number' ? skill.base : 0);
                        
                        const occ = parseInt(occPoints.value || 0);
                        const int = parseInt(intPoints.value || 0);
                        const growth = parseInt(growthPoints.value || 0);
                        
                        // 处理教育值为空的情况
                        if (base === '') {
                            // 如果教育值为空，则成功率也为空
                            regularSuccess.textContent = '';
                            hardSuccess.textContent = '';
                            extremeSuccess.textContent = '';
                            
                            // 移除填充标记
                            delete regularSuccess.dataset.filled;
                            delete hardSuccess.dataset.filled;
                            delete extremeSuccess.dataset.filled;
                            
                            // 更新剩余点数
                            calculateRemainingPoints();
                            return;
                        }
                        
                        const total = base + occ + int + growth;
                        
                        // 更新成功率
                        regularSuccess.textContent = total;
                        hardSuccess.textContent = Math.floor(total / 2);
                        extremeSuccess.textContent = Math.floor(total / 5);
                        
                        // 设置数据属性以便打印时控制显示
                        regularSuccess.dataset.filled = total > 0 ? "true" : "false";
                        hardSuccess.dataset.filled = Math.floor(total / 2) > 0 ? "true" : "false";
                        extremeSuccess.dataset.filled = Math.floor(total / 5) > 0 ? "true" : "false";
                        
                        // 更新剩余点数
                        calculateRemainingPoints();
                    });
                });
                
                return skillItem;
            }
            
            // 创建有子技能的技能项函数
            function createSkillItemWithSubtypes(skill) {
                const skillItem = document.createElement('div');
                skillItem.className = 'skill-item';
                
                skillItem.dataset.skillName = skill.name;
                
                // 职业技能复选框
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'skill-checkbox';
                skillItem.appendChild(checkbox);
                
                // 技能名称
                const nameContainer = document.createElement('div');
                nameContainer.className = 'skill-name';
                
                const nameText = document.createElement('div');
                nameText.className = 'skill-name-text';
                nameText.textContent = skill.name + ": ";
                nameText.style.width = 'auto';
                nameText.style.minWidth = 'unset';
                nameContainer.appendChild(nameText);
                
                // 添加子技能选择按钮
                const selectBtn = document.createElement('div');
                selectBtn.className = 'skill-subtype-btn';
                selectBtn.textContent = '选择...';
                selectBtn.dataset.skillName = skill.name;
                selectBtn.addEventListener('click', function() {
                    openSubtypeModal(skill, this);
                });
                
                // 创建选中后的显示区域
                const subtypeDisplay = document.createElement('span');
                subtypeDisplay.className = 'skill-subtype-display';
                subtypeDisplay.style.display = 'none';
                
                nameContainer.appendChild(selectBtn);
                nameContainer.appendChild(subtypeDisplay);
                
                skillItem.appendChild(nameContainer);
                
                // 基础值和点数分配
                const pointsContainer = document.createElement('div');
                pointsContainer.className = 'skill-points';
                
                // 基础值
                const baseValue = document.createElement('div');
                baseValue.className = 'skill-base';
                baseValue.textContent = '0'; // 默认值，会根据选择的子技能更新
                pointsContainer.appendChild(baseValue);
                
                // 职业点数
                const occPoints = document.createElement('input');
                occPoints.type = 'text';
                occPoints.className = 'skill-point-input occupation-points';
                occPoints.dataset.min = 0;
                occPoints.maxLength = 3; // 限制最多输入3位数字
                occPoints.addEventListener('input', function() {
                    validateNonNegativeInteger(this);
                });
                occPoints.addEventListener('blur', function() {
                    validateNonNegativeInteger(this);
                });
                pointsContainer.appendChild(occPoints);
                
                // 兴趣点数
                const intPoints = document.createElement('input');
                intPoints.type = 'text';
                intPoints.className = 'skill-point-input interest-points';
                intPoints.dataset.min = 0;
                intPoints.maxLength = 3; // 限制最多输入3位数字
                intPoints.addEventListener('input', function() {
                    validateNonNegativeInteger(this);
                });
                intPoints.addEventListener('blur', function() {
                    validateNonNegativeInteger(this);
                });
                pointsContainer.appendChild(intPoints);
                
                // 成长点数
                const growthPoints = document.createElement('input');
                growthPoints.type = 'text';
                growthPoints.className = 'skill-point-input growth-points';
                growthPoints.dataset.min = 0;
                growthPoints.maxLength = 3; // 限制最多输入3位数字
                growthPoints.addEventListener('input', function() {
                    validateNonNegativeInteger(this);
                });
                growthPoints.addEventListener('blur', function() {
                    validateNonNegativeInteger(this);
                });
                pointsContainer.appendChild(growthPoints);
                
                skillItem.appendChild(pointsContainer);
                
                // 成功率
                const totalContainer = document.createElement('div');
                totalContainer.className = 'skill-total';
                
                // 常规成功
                const regularSuccess = document.createElement('div');
                regularSuccess.className = 'skill-result regular-success';
                regularSuccess.textContent = '0';
                totalContainer.appendChild(regularSuccess);
                
                // 困难成功
                const hardSuccess = document.createElement('div');
                hardSuccess.className = 'skill-result hard-success';
                hardSuccess.textContent = '0';
                totalContainer.appendChild(hardSuccess);
                
                // 极难成功
                const extremeSuccess = document.createElement('div');
                extremeSuccess.className = 'skill-result extreme-success';
                extremeSuccess.textContent = '0';
                totalContainer.appendChild(extremeSuccess);
                
                skillItem.appendChild(totalContainer);
                
                // 更新基础值的函数
                function updateBaseValue(newBase) {
                    baseValue.textContent = newBase;
                    updateSuccessValues();
                }
                
                // 更新成功率的函数
                function updateSuccessValues() {
                    const base = parseInt(baseValue.textContent || 0);
                    const occ = parseInt(occPoints.value || 0);
                    const int = parseInt(intPoints.value || 0);
                    const growth = parseInt(growthPoints.value || 0);
                    
                    const total = base + occ + int + growth;
                    
                    regularSuccess.textContent = total;
                    hardSuccess.textContent = Math.floor(total / 2);
                    extremeSuccess.textContent = Math.floor(total / 5);
                    
                    // 设置数据属性以便打印时控制显示
                    regularSuccess.dataset.filled = total > 0 ? "true" : "false";
                    hardSuccess.dataset.filled = Math.floor(total / 2) > 0 ? "true" : "false";
                    extremeSuccess.dataset.filled = Math.floor(total / 5) > 0 ? "true" : "false";
                    
                    // 更新剩余点数
                    calculateRemainingPoints();
                }
                
                // 添加点数变更监听器
                const pointInputs = [occPoints, intPoints, growthPoints];
                pointInputs.forEach(input => {
                    input.addEventListener('input', updateSuccessValues);
                });
                
                return skillItem;
            }
            
            // 修改技能生成代码，按basic.txt的顺序排列技能
            // 清空原有的skills-container内容
            skillsContainer.innerHTML = '';

            // 按照basic.txt的顺序重新组织技能数据
            const orderedSkills = [
                "信用评级", "克苏鲁神话", "侦查", "聆听", "图书馆使用", "计算机使用", 
                "潜行", "追踪", "导航", "话术", "说服", "取悦", "恐吓", "心理学", 
                "母语", "外语", "闪避", "格斗", "射击", "投掷", "急救", "医学", "精神分析", 
                "攀爬", "跳跃", "游泳", "博物学", "神秘学", "考古学", "人类学", "估价", 
                "会计", "法律", "历史", "电子学", "科学", "乔装", "妙手", "锁匠", 
                "机械维修", "电气维修", "驯兽", "技艺", "生存", "汽车驾驶", "骑术", "操作重型机械", "驾驶"
            ];

            // 创建映射，便于查找技能数据
            const skillMap = {};
            skillsData.forEach(skill => {
                skillMap[skill.name] = skill;
            });

            // 计算技能项总数和每列的技能项数
            let totalItems = 0;
            const skillItemCounts = orderedSkills.map(skillName => {
                const skill = skillMap[skillName];
                if (!skill) return 0;
                
                if (skill.subtypes && skill.rows && skill.rows > 0) {
                    return skill.rows;
                } else {
                    return 1;
                }
            });
            
            totalItems = skillItemCounts.reduce((sum, count) => sum + count, 0);
            const itemsPerColumn = Math.ceil(totalItems / 2);
            
            // 生成所有技能项
            const allSkillItems = [];
            
            // 处理排序后的技能
            for (const skillName of orderedSkills) {
                const skill = skillMap[skillName];
                
                // 跳过未找到的技能
                if (!skill) continue;
                
                if (skill.subtypes && skill.rows && skill.rows > 0) {
                    // 带子技能的技能，生成指定数量的子技能项
                    const count = skill.rows || 1;
                    
                    for (let i = 0; i < count; i++) {
                        // 创建子技能项
                        const skillItem = createSkillItemWithSubtypes(skill);
                        skillItem.classList.add('subtype-skill');
                        allSkillItems.push(skillItem);
                    }
                } else {
                    // 普通技能，直接添加
                    const skillItem = createSkillItem(skill);
                    allSkillItems.push(skillItem);
                }
            }
            
            // 按行生成技能网格
            for (let i = 0; i < Math.ceil(allSkillItems.length / 2); i++) {
                const row = document.createElement('div');
                row.className = 'skill-row';
                // 添加奇偶行标记类
                if (i % 2 === 0) {
                    row.classList.add('even-row');
                } else {
                    row.classList.add('odd-row');
                }
                
                // 左侧列
                if (i < allSkillItems.length) {
                    allSkillItems[i].classList.add('left-column-cell');
                    row.appendChild(allSkillItems[i]);
                } else {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'skill-item left-column-cell';
                    emptyItem.style.visibility = 'hidden';
                    row.appendChild(emptyItem);
                }
                
                // 右侧列
                const rightIndex = i + itemsPerColumn;
                if (rightIndex < allSkillItems.length) {
                    allSkillItems[rightIndex].classList.add('right-column-cell');
                    row.appendChild(allSkillItems[rightIndex]);
                } else {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'skill-item right-column-cell';
                    emptyItem.style.visibility = 'hidden';
                    row.appendChild(emptyItem);
                }
                
                skillsContainer.appendChild(row);
            }
            
            // 添加子技能选择模态窗口功能
            const modal = document.getElementById('subtype-modal');
            const closeBtn = document.querySelector('.close-modal');
            const subtypeList = document.getElementById('subtype-list');
            
            let currentSkill = null;
            let currentButton = null;
            
            // 打开模态窗口
            function openSubtypeModal(skill, button) {
                currentSkill = skill;
                currentButton = button;
                
                // 清空列表
                subtypeList.innerHTML = '';
                
                // 添加分类标题
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'subtype-category';
                categoryTitle.textContent = skill.name + '子技能';
                subtypeList.appendChild(categoryTitle);
                
                // 填充子技能列表
                if (skill.subtypes) {
                    if (Array.isArray(skill.subtypes) && !skill.subtypes[0].name) {
                        // 普通字符串数组
                        skill.subtypes.forEach(subtype => {
                            addSubtypeItem(subtype, skill.base);  // 修改这里，使用技能的base值
                        });
                    } else {
                        // 对象数组
                        skill.subtypes.forEach(subtype => {
                            const name = typeof subtype === 'object' ? subtype.name : subtype;
                            const base = typeof subtype === 'object' ? subtype.base : skill.base;
                            addSubtypeItem(name, base);
                        });
                    }
                }
                
                // 显示模态窗口
                modal.style.display = 'block';
            }
            
            // 添加子技能项
            function addSubtypeItem(name, base) {
                const item = document.createElement('div');
                item.className = 'subtype-item';
                item.textContent = name;
                item.addEventListener('click', function() {
                    selectSubtype(name, base);
                });
                subtypeList.appendChild(item);
            }
            
            // 选择子技能
            function selectSubtype(name, base) {
                if (!currentButton || !currentSkill) return;
                
                // 找到父元素
                const skillItem = currentButton.closest('.skill-item');
                if (!skillItem) return;
                
                // 更新显示
                const subtypeDisplay = skillItem.querySelector('.skill-subtype-display');
                subtypeDisplay.textContent = name;
                subtypeDisplay.style.display = 'inline-block';
                
                // 不再隐藏选择按钮，而是改变其文本
                currentButton.textContent = '更改';
                currentButton.style.display = 'inline-block'; // 确保按钮仍然可见
                
                // 添加类来区分选择前后的状态
                currentButton.classList.add('has-selection');
                
                // 更新基础值 - 特殊处理母语技能
                const baseElement = skillItem.querySelector('.skill-base');
                if (baseElement) {
                    // 检查是否为母语技能
                    if (currentSkill.name === '母语' && currentSkill.base === 'edu') {
                        // 选择子技能后，激活教育值关联
                        baseElement.dataset.baseType = "edu-active";
                        // 使用教育值
                        const eduInput = document.getElementById('edu');
                        const eduValue = eduInput && eduInput.value ? parseInt(eduInput.value) : 0;
                        baseElement.textContent = eduValue;
                        
                        // 立即更新成功率
                        setTimeout(updateLanguageBaseValues, 0);
                    } else {
                        // 其他技能使用原来的逻辑
                    const baseValue = typeof base === 'string' || typeof base === 'number' ? base : currentSkill.base;
                    baseElement.textContent = baseValue;
                    }
                    
                    // 触发值更新
                    const inputs = skillItem.querySelectorAll('.skill-point-input');
                    if (inputs.length) {
                        inputs[0].dispatchEvent(new Event('input'));
                    }
                }
                
                // 关闭模态窗口
                closeModal();
            }
            
            // 关闭模态窗口
            function closeModal() {
                modal.style.display = 'none';
                currentSkill = null;
                currentButton = null;
            }
            
            // 点击关闭按钮
            closeBtn.addEventListener('click', closeModal);
            
            // 点击模态窗口外部关闭
            window.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
            
            // 按ESC键关闭
            window.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display === 'block') {
                    closeModal();
                }
            });

            // 生成自定义技能行
            const customSkillsContainer = document.getElementById('custom-skills-container');
            if (customSkillsContainer) {
                const totalCustomSkills = 86; // 生成86条自定义技能记录
                const customSkillsPerRow = 2; // 每行2条
                const totalRows = Math.ceil(totalCustomSkills / customSkillsPerRow);
                
                // 生成所有行
                for (let i = 0; i < totalRows; i++) {
                    const row = document.createElement('div');
                    row.className = 'custom-skill-row';
                    // 添加奇偶行标记类
                    if (i % 2 === 0) {
                        row.classList.add('custom-even-row');
                    } else {
                        row.classList.add('custom-odd-row');
                    }
                    
                    // 第一列
                    const item1 = createCustomSkillItem(i * 2);
                    item1.classList.add('custom-left-column-cell');
                    row.appendChild(item1);
                    
                    // 第二列
                    if (i * 2 + 1 < totalCustomSkills) {
                        const item2 = createCustomSkillItem(i * 2 + 1);
                        item2.classList.add('custom-right-column-cell');
                        row.appendChild(item2);
                    } else {
                        // 如果没有足够的技能填满行，添加空项
                        const emptyItem = document.createElement('div');
                        emptyItem.className = 'custom-skill-item custom-right-column-cell';
                        emptyItem.style.visibility = 'hidden';
                        row.appendChild(emptyItem);
                    }
                    
                    customSkillsContainer.appendChild(row);
                }
            }

            // 立即同步调查员信息
            setTimeout(syncInvestigatorInfo, 200);

            // 为所有姓名输入框添加事件监听器
            const nameInputs = document.querySelectorAll('.sheet-section:first-child input.field-input');
            nameInputs.forEach(input => {
                input.addEventListener('input', syncInvestigatorInfo);
                input.addEventListener('change', syncInvestigatorInfo);
                input.addEventListener('blur', syncInvestigatorInfo);
            });

            // 武器区域的交互
            setupWeaponEvents();

            // 添加教育值变化监听器，用于更新母语技能的基础值
            const eduInputElem = document.getElementById('edu');
            eduInputElem.addEventListener('input', updateLanguageBaseValues);
            eduInputElem.addEventListener('change', updateLanguageBaseValues);
            
            // 初始更新一次母语技能基础值
            setTimeout(updateLanguageBaseValues, 500);
            
            // 再次确保在页面完全加载后更新一次
            setTimeout(updateLanguageBaseValues, 1500);

            // 战斗区域的交互
            setupCombatEvents();

            // 初始化页面显示和导航功能
            setupPageNavigation();

            // 设置保存按钮图标和事件
            const saveButton = document.querySelector('.float-nav-button:nth-child(2)');
            saveButton.innerHTML = '<div class="save-icon"></div>';
            saveButton.title = '保存';
            saveButton.addEventListener('click', saveCharacterSheet);

            // 设置加载对话框按钮事件
            document.getElementById('load-yes').addEventListener('click', function() {
                loadCharacterSheet();
                document.querySelector('.load-dialog-overlay').style.display = 'none';
                document.querySelector('.load-dialog').style.display = 'none';
            });

            document.getElementById('load-no').addEventListener('click', function() {
                // 关闭对话框
                document.querySelector('.load-dialog-overlay').style.display = 'none';
                document.querySelector('.load-dialog').style.display = 'none';
                
                // 清除localStorage中的数据，避免下次打开页面再次提示
                localStorage.removeItem('characterSheet');
            });

            // 检查是否有保存的数据
            checkSavedData();

            // 设置打印按钮
            const printButton = document.querySelector('.float-nav-button:nth-child(3)');
            printButton.title = '打印';
            printButton.addEventListener('click', openPrintModal);

            // 打印模态窗口相关元素
            const printModal = document.getElementById('print-modal');
            const closePrintModal = printModal.querySelector('.close-modal');
            const confirmPrintBtn = document.getElementById('confirm-print');

            // 关闭打印模态窗口
            function closePrintDialog() {
                printModal.style.display = 'none';
            }

            // 打开打印模态窗口
            function openPrintModal() {
                printModal.style.display = 'block';
            }

            // 关闭按钮事件
            closePrintModal.addEventListener('click', closePrintDialog);

            // 点击模态窗口外部关闭
            window.addEventListener('click', function(e) {
                if (e.target === printModal) {
                    closePrintDialog();
                }
            });

            // 确认打印按钮事件
            confirmPrintBtn.addEventListener('click', function() {
                // 获取选择状态
                const printMain = document.getElementById('print-main').checked;
                const printCustom = document.getElementById('print-custom').checked;
                const printItems = document.getElementById('print-items').checked;

                // 如果没有选择任何页面，提示用户
                if (!printMain && !printCustom && !printItems) {
                    alert('请至少选择一个要打印的页面。');
                    return;
                }

                // 获取页面元素
                const mainPage = document.querySelector('.character-sheet');
                const customPage = document.querySelector('.custom-page');
                const itemsPage = document.querySelector('.items-page');
                const pageTitle = document.querySelector('.page-title');
                const floatNav = document.querySelector('.float-nav');

                // 保存原始显示状态
                const originalMainDisplay = mainPage.style.display;
                const originalCustomDisplay = customPage.style.display;
                const originalItemsDisplay = itemsPage.style.display;
                const originalTitleDisplay = pageTitle.style.display;
                const originalNavDisplay = floatNav.style.display;

                // 设置打印时的显示状态
                mainPage.style.display = printMain ? 'grid' : 'none';
                customPage.style.display = printCustom ? 'flex' : 'none';
                itemsPage.style.display = printItems ? 'flex' : 'none';
                pageTitle.style.display = 'none';
                floatNav.style.display = 'none';

                // 关闭打印对话框
                closePrintDialog();

                // 添加临时打印样式
                const style = document.createElement('style');
                style.textContent = `
                    @media print {
                        @page { size: A4; margin: 0.5cm; }
                        body { margin: 0; padding: 0; }
                        .character-sheet, .custom-page, .items-page {
                            page-break-after: always !important;
                            page-break-inside: avoid !important;
                        }
                        .custom-page {
                            display: flex !important;
                            flex-direction: column !important;
                        }
                        /* 隐藏所有未选中的页面 */
                        .character-sheet { display: ${printMain ? 'grid' : 'none'} !important; }
                        .custom-page { display: ${printCustom ? 'flex' : 'none'} !important; }
                        .items-page { display: ${printItems ? 'flex' : 'none'} !important; }
                    }
                `;
                document.head.appendChild(style);

                // 延迟执行打印
                setTimeout(() => {
                    window.print();

                    // 打印完成后恢复原始状态
                    setTimeout(() => {
                        mainPage.style.display = originalMainDisplay;
                        customPage.style.display = originalCustomDisplay;
                        itemsPage.style.display = originalItemsDisplay;
                        pageTitle.style.display = originalTitleDisplay;
                        floatNav.style.display = originalNavDisplay;
                        document.head.removeChild(style);
                    }, 100);
                }, 200);
            });
        });

        // 创建自定义技能项目
        function createCustomSkillItem(index) {
            const skillItem = document.createElement('div');
            skillItem.className = 'custom-skill-item';
            skillItem.dataset.index = index;
            
            // 技能名称输入
            const nameContainer = document.createElement('div');
            nameContainer.className = 'custom-skill-name';
            
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.className = 'custom-skill-name-input';
            nameInput.placeholder = '输入技能名称...';
            nameContainer.appendChild(nameInput);
            
            skillItem.appendChild(nameContainer);
            
            // 基础值和点数分配
            const pointsContainer = document.createElement('div');
            pointsContainer.className = 'custom-skill-points';
            
            // 基础值 - 将类型从input改为div，固定为0
            const baseValue = document.createElement('div');
            baseValue.className = 'custom-skill-base';
            baseValue.textContent = '0'; // 默认设置为0
            baseValue.dataset.value = '0';
            pointsContainer.appendChild(baseValue);
            
            // 职业点数
            const occPoints = document.createElement('input');
            occPoints.type = 'text';
            occPoints.className = 'custom-skill-point-input custom-occupation-points';
            occPoints.dataset.min = 0;
            occPoints.maxLength = 3;
            occPoints.addEventListener('input', function() {
                validateNonNegativeInteger(this);
                updateCustomSkillTotals(skillItem);
            });
            occPoints.addEventListener('blur', function() {
                validateNonNegativeInteger(this);
                updateCustomSkillTotals(skillItem);
            });
            pointsContainer.appendChild(occPoints);
            
            // 兴趣点数
            const intPoints = document.createElement('input');
            intPoints.type = 'text';
            intPoints.className = 'custom-skill-point-input custom-interest-points';
            intPoints.dataset.min = 0;
            intPoints.maxLength = 3;
            intPoints.addEventListener('input', function() {
                validateNonNegativeInteger(this);
                updateCustomSkillTotals(skillItem);
            });
            intPoints.addEventListener('blur', function() {
                validateNonNegativeInteger(this);
                updateCustomSkillTotals(skillItem);
            });
            pointsContainer.appendChild(intPoints);
            
            // 成长点数
            const growthPoints = document.createElement('input');
            growthPoints.type = 'text';
            growthPoints.className = 'custom-skill-point-input custom-growth-points';
            growthPoints.dataset.min = 0;
            growthPoints.maxLength = 3;
            growthPoints.addEventListener('input', function() {
                validateNonNegativeInteger(this);
                updateCustomSkillTotals(skillItem);
            });
            growthPoints.addEventListener('blur', function() {
                validateNonNegativeInteger(this);
                updateCustomSkillTotals(skillItem);
            });
            pointsContainer.appendChild(growthPoints);
            
            skillItem.appendChild(pointsContainer);
            
            // 成功率
            const totalContainer = document.createElement('div');
            totalContainer.className = 'custom-skill-total';
            
            // 常规成功
            const regularSuccess = document.createElement('div');
            regularSuccess.className = 'custom-skill-result custom-regular-success';
            regularSuccess.textContent = '0';
            regularSuccess.dataset.filled = "true"; // 设置为true使其在打印时显示
            totalContainer.appendChild(regularSuccess);
            
            // 困难成功
            const hardSuccess = document.createElement('div');
            hardSuccess.className = 'custom-skill-result custom-hard-success';
            hardSuccess.textContent = '0';
            hardSuccess.dataset.filled = "true"; // 设置为true使其在打印时显示
            totalContainer.appendChild(hardSuccess);
            
            // 极难成功
            const extremeSuccess = document.createElement('div');
            extremeSuccess.className = 'custom-skill-result custom-extreme-success';
            extremeSuccess.textContent = '0';
            extremeSuccess.dataset.filled = "true"; // 设置为true使其在打印时显示
            totalContainer.appendChild(extremeSuccess);
            
            skillItem.appendChild(totalContainer);
            
            // 立即更新一次技能总值
            setTimeout(function() {
                updateCustomSkillTotals(skillItem);
            }, 0);
            
            return skillItem;
        }
        
        // 更新自定义技能总值函数
        function updateCustomSkillTotals(skillItem) {
            const baseValue = skillItem.querySelector('.custom-skill-base');
            const occInput = skillItem.querySelector('.custom-occupation-points');
            const intInput = skillItem.querySelector('.custom-interest-points');
            const growthInput = skillItem.querySelector('.custom-growth-points');
            
            // 基础值固定为0
            const base = 0;
            const occ = parseInt(occInput.value || 0);
            const int = parseInt(intInput.value || 0);
            const growth = parseInt(growthInput.value || 0);
            
            const total = base + occ + int + growth;
            
            const regularSuccess = skillItem.querySelector('.custom-regular-success');
            const hardSuccess = skillItem.querySelector('.custom-hard-success');
            const extremeSuccess = skillItem.querySelector('.custom-extreme-success');
            
            regularSuccess.textContent = total;
            hardSuccess.textContent = Math.floor(total / 2);
            extremeSuccess.textContent = Math.floor(total / 5);
            
            // 设置数据属性以便打印时控制显示
            regularSuccess.dataset.filled = total > 0 ? "true" : "true"; // 始终显示
            hardSuccess.dataset.filled = total > 0 ? "true" : "true"; // 始终显示
            extremeSuccess.dataset.filled = total > 0 ? "true" : "true"; // 始终显示
        }
        
        // 同步调查员信息到引用区域
        function syncInvestigatorInfo() {
            // 只获取姓名输入框
            const nameInput = document.querySelector('.sheet-section:first-child .field-row:nth-child(2) .field-input');
            const refName = document.getElementById('ref-name');
            const refNameItems = document.getElementById('ref-name-items');

            if (nameInput) {
                const nameValue = nameInput.value || '-';
                if (refName) {
                    refName.textContent = nameValue;
                }
                if (refNameItems) {
                    refNameItems.textContent = nameValue;
            }
        }}

        // DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 设置保存按钮图标和事件
            const saveButton = document.querySelector('.float-nav-button:nth-child(2)');
            saveButton.innerHTML = '<div class="save-icon"></div>';
            saveButton.title = '保存';
            saveButton.addEventListener('click', saveCharacterSheet);

            // 设置加载对话框按钮事件
            document.getElementById('load-yes').addEventListener('click', function() {
                loadCharacterSheet();
                document.querySelector('.load-dialog-overlay').style.display = 'none';
                document.querySelector('.load-dialog').style.display = 'none';
            });

            document.getElementById('load-no').addEventListener('click', function() {
                // 关闭对话框
                document.querySelector('.load-dialog-overlay').style.display = 'none';
                document.querySelector('.load-dialog').style.display = 'none';
                
                // 清除localStorage中的数据，避免下次打开页面再次提示
                localStorage.removeItem('characterSheet');
            });

            // 检查是否有保存的数据
            checkSavedData();
        });

        // 初始化武器区域的事件处理
        function setupWeaponEvents() {
            const weaponNames = document.querySelectorAll('.weapon-name');
            const weaponDamages = document.querySelectorAll('.weapon-damage');
            const weaponFeatures = document.querySelectorAll('.weapon-feature');
            
            // 为所有武器名称区域添加点击事件
            weaponNames.forEach(nameCell => {
                nameCell.addEventListener('click', function() {
                    showInputField(this, '.weapon-name-input');
                });
            });
            
            // 为所有武器伤害区域添加点击事件
            weaponDamages.forEach(damageCell => {
                damageCell.addEventListener('click', function() {
                    showInputField(this, '.weapon-damage-input');
                });
            });
            
            // 为所有武器特性区域添加点击事件
            weaponFeatures.forEach(featureCell => {
                featureCell.addEventListener('click', function() {
                    showInputField(this, '.weapon-feature-input');
                });
            });
            
            // 为所有武器输入框添加失去焦点和按键事件
            document.querySelectorAll('.weapon-name-input, .weapon-damage-input, .weapon-feature-input').forEach(input => {
                // 失去焦点时隐藏输入框并更新显示文本
                input.addEventListener('blur', function() {
                    updateWeaponField(this);
                });
                
                // 按Enter键时也执行同样的操作
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        updateWeaponField(this);
                        e.preventDefault();
                    }
                });
            });
        }
        
        // 显示输入框
        function showInputField(cell, inputSelector) {
            const input = cell.querySelector(inputSelector);
            const textElement = cell.querySelector('div[class$="-text"]');
            
            // 如果文本不为空，则将其设置为输入框的值
            if (textElement.textContent.trim() !== '') {
                input.value = textElement.textContent;
            } else {
                input.value = '';
            }
            
            // 显示输入框并聚焦
            input.style.display = 'block';
            input.focus();
        }
        
        // 更新武器区域的显示
        function updateWeaponField(input) {
            const cell = input.parentElement;
            const textElement = cell.querySelector('div[class$="-text"]');
            
            // 获取输入的值
            const value = input.value.trim();
            
            // 更新显示文本，空值时显示空字符串，不显示横杠
            textElement.textContent = value === '' ? '' : value;
            
            // 隐藏输入框
            input.style.display = 'none';
        }

        // 更新母语技能基础值的函数
        function updateLanguageBaseValues() {
            // 获取教育值，但不默认为0
            const eduInput = document.getElementById('edu');
            const eduValue = eduInput && eduInput.value ? parseInt(eduInput.value) : 0;
            
            // 遍历所有技能项
            document.querySelectorAll('.skill-item').forEach(item => {
                const nameText = item.querySelector('.skill-name-text');
                const baseElement = item.querySelector('.skill-base');
                
                // 只处理已激活的母语技能（已选择子技能的）
                if (baseElement && baseElement.dataset.baseType === "edu-active") {
                    // 更新基础值为教育值
                    baseElement.textContent = eduValue;
                    
                    // 获取点数输入值
                    const occValue = parseInt(item.querySelector('.occupation-points')?.value || 0);
                    const intValue = parseInt(item.querySelector('.interest-points')?.value || 0);
                    const growthValue = parseInt(item.querySelector('.growth-points')?.value || 0);
                    
                    // 计算总值
                    const total = eduValue + occValue + intValue + growthValue;
                    
                    // 更新成功率显示
                    const results = item.querySelectorAll('.skill-result');
                    if (results.length >= 3) {
                        // 更新成功率
                        results[0].textContent = total;
                        results[1].textContent = Math.floor(total / 2);
                        results[2].textContent = Math.floor(total / 5);
                        
                        // 设置填充标记
                        if (total > 0) results[0].dataset.filled = "true";
                        else delete results[0].dataset.filled;
                        
                        if (Math.floor(total / 2) > 0) results[1].dataset.filled = "true";
                        else delete results[1].dataset.filled;
                        
                        if (Math.floor(total / 5) > 0) results[2].dataset.filled = "true";
                        else delete results[2].dataset.filled;
                    }
                }
            });
        }
        
        // 添加初始化时触发EDU输入框的更新事件
        document.addEventListener('DOMContentLoaded', function() {
            // 确保在技能加载后执行
            setTimeout(function() {
                // 调用更新函数，但不设置默认值
                updateLanguageBaseValues();
            }, 1000);
        });

        // 初始化战斗区域的事件处理
        function setupCombatEvents() {
            // 获取所有战斗区域的输入框
            const combatInputs = document.querySelectorAll('.combat-input');
            
            // 为每个输入框添加事件监听，自动保存用户输入
            combatInputs.forEach(input => {
                // 从本地存储加载已保存的值
                const savedValue = localStorage.getItem(input.id);
                if (savedValue) {
                    input.value = savedValue;
                }
                
                // 监听输入变化
                input.addEventListener('input', function() {
                    // 如果是数字类型的输入框,限制最大3位数字
                    if (this.type === 'number') {
                        if (this.value > 999) {
                            this.value = 999;
                        }
                    } else {
                        // 文本类型输入框限制最大5个字符
                        if (this.value.length > 5) {
                            this.value = this.value.slice(0, 5);
                        }
                    }
                    
                    // 保存到本地存储
                    localStorage.setItem(this.id, this.value);
                });
                
                // 添加失焦事件以确保数据保存
                input.addEventListener('blur', function() {
                    // 只对数字类型输入框进行数值验证
                    if (this.type === 'number') {
                        if (this.value === '') {
                            this.value = 0;
                        } else if (this.value > 999) {
                            this.value = 999;
                        }
                    }
                    
                    localStorage.setItem(this.id, this.value);
                });
            });
        }

        // 初始化页面显示和导航功能
        function setupPageNavigation() {
            // 获取所有页面元素
            const mainPage = document.querySelector('.character-sheet');
            const customPage = document.querySelector('.custom-page');
            const itemsPage = document.querySelector('.items-page');
            const pageNavBtn = document.getElementById('page-nav-btn');
            const allPages = [mainPage, customPage, itemsPage];
            const pageTitle = document.querySelector('.page-title');
            
            // 页面标题配置
            const titles = [
                "COC 7版人物卡 - 主页面",
                "COC 7版人物卡 - 自定义技能页",
                "COC 7版人物卡 - 道具页"
            ];
            
            // 当前页面索引
            let currentPageIndex = 0;
            
            // 更新页面标题函数
            function updatePageTitle() {
                pageTitle.textContent = titles[currentPageIndex];
            }
            
            // 初始状态：设置初始标题，隐藏除主页面外的所有页面
            updatePageTitle();
            allPages.forEach((page, index) => {
                if (index !== 0) {
                    page.style.display = 'none';
                }
            });
            
            // 添加翻页按钮点击事件
            pageNavBtn.addEventListener('click', function() {
                // 隐藏当前页面
                allPages[currentPageIndex].style.display = 'none';
                
                // 更新页面索引（循环切换）
                currentPageIndex = (currentPageIndex + 1) % allPages.length;
                
                // 更新页面标题
                updatePageTitle();
                
                // 显示新的当前页面
                allPages[currentPageIndex].style.display = allPages[currentPageIndex].classList.contains('custom-page') || allPages[currentPageIndex].classList.contains('items-page') ? 'flex' : 'grid';
            });
            
            // 添加打印前处理：只打印当前页面
            window.addEventListener('beforeprint', function pagePrintHandler(e) {
                // 彻底隐藏所有分页符，防止产生空白页
                document.querySelectorAll('.page-break').forEach(pb => {
                    pb.style.display = 'none';
                    pb.style.height = '0';
                    pb.style.margin = '0';
                    pb.style.padding = '0';
                    pb.style.visibility = 'hidden';
                    pb.style.position = 'absolute';
                    pb.style.pageBreakAfter = 'avoid';
                    pb.style.pageBreakBefore = 'avoid';
                });
                
                // 只打印当前页面，隐藏其他页面
                allPages.forEach((page, index) => {
                    if (index !== currentPageIndex) {
                        page.dataset.originalDisplay = page.style.display;
                        page.style.display = 'none';
                    } else {
                        // 确保当前页面正确显示
                        page.style.display = page.classList.contains('custom-page') || page.classList.contains('items-page') ? 'flex' : 'grid';
                        
                        // 移除当前页面的外边框和阴影
                        page.style.border = 'none';
                        page.style.boxShadow = 'none';
                        page.style.margin = '0';
                        page.style.padding = '0';
                        
                        // 确保内部区域边框正常显示
                        page.querySelectorAll('.sheet-section').forEach(section => {
                            section.style.border = '1px solid var(--border-color)';
                            section.style.margin = '2px';
                        });
                    }
                });
                
                // 移除可能导致空白页的元素
                document.querySelectorAll('body > *:not(.character-sheet):not(.custom-page):not(.items-page):not(.page-title):not(.float-nav)').forEach(el => {
                    if (el.tagName !== 'SCRIPT' && el.tagName !== 'STYLE') {
                        el.dataset.originalDisplay = el.style.display;
                        el.style.display = 'none';
                    }
                });
                
                // 设置HTML和body样式，防止生成多余页面
                document.documentElement.style.margin = '0';
                document.documentElement.style.padding = '0';
                document.body.style.margin = '0';
                document.body.style.padding = '0';
                document.body.style.height = 'auto';
                document.body.style.overflow = 'visible';
                
                // 强制浏览器渲染样式变化
                document.body.offsetHeight;
            });
            
            // 打印后处理：恢复页面显示
            window.addEventListener('afterprint', function pageAfterPrintHandler(e) {
                // 恢复页面显示
                allPages.forEach((page, index) => {
                    if (index !== currentPageIndex) {
                        page.style.display = 'none';
                    } else {
                        // 恢复当前页面显示
                        page.style.display = page.classList.contains('custom-page') ? 'flex' : 'grid';
                        
                        // 恢复页面的边框和样式
                        page.style.border = '1px solid var(--border-color)';
                        page.style.boxShadow = '0 0 5px rgba(0, 0, 0, 0.1)';
                        page.style.margin = '2px auto 10px auto';
                        page.style.padding = '5px';
                        
                        // 恢复内部区域的样式
                        page.querySelectorAll('.sheet-section').forEach(section => {
                            section.style.border = '';
                            section.style.margin = '';
                        });
                    }
                });
                
                // 恢复其他元素的显示
                document.querySelectorAll('[data-original-display]').forEach(el => {
                    if (el.dataset.originalDisplay) {
                        el.style.display = el.dataset.originalDisplay;
                        delete el.dataset.originalDisplay;
                    }
                });
                
                // 恢复HTML和body样式
                document.documentElement.style.margin = '';
                document.documentElement.style.padding = '';
                document.body.style.margin = '';
                document.body.style.padding = '';
                document.body.style.height = '';
                document.body.style.overflow = '';
            });
        }

        // 添加打印前的缩放设置
        window.addEventListener('beforeprint', function() {
            document.body.style.zoom = '96%';
            const sheets = document.querySelectorAll('.character-sheet');
            sheets.forEach(sheet => {
                sheet.style.transform = 'scale(0.96)';
                sheet.style.transformOrigin = 'top left';
            });
        });

        // 打印后恢复正常缩放
        window.addEventListener('afterprint', function() {
            document.body.style.zoom = '100%';
            const sheets = document.querySelectorAll('.character-sheet');
            sheets.forEach(sheet => {
                sheet.style.transform = 'none';
            });
        });

        // 保存功能
        function saveCharacterSheet(showAlert = true) {
            // 如果正在加载数据，不执行保存操作
            if (window.isLoading) {
                console.log('正在加载数据，跳过保存操作');
                return;
            }
            
            try {
                console.log('开始保存角色卡...');
                
                // 获取基本信息区域 - 增加更多防御性检查
                const basicInfoSection = document.querySelector('.basic-info-section');
                if (!basicInfoSection) {
                    console.error('未找到基本信息区域');
                    // 创建一个最小的数据对象，确保保存过程可以继续
                    const minimalData = {
                        basicInfo: { name: '', player: '' },
                        characteristics: {},
                        avatar: '',
                        stats: { san: {}, hp: {}, mp: {} },
                        skillPoints: { occupation: '', interest: '' },
                        skills: [],
                        customSkills: [],
                        weapons: [],
                        combat: {},
                        items: []
                    };
                    
                    localStorage.setItem('characterSheet', JSON.stringify(minimalData));
                    if (showAlert) {
                        alert('保存成功！(最小数据)');
                    }
                    return;
                }
                
                console.log('找到基本信息区域');
                
                // 获取并验证姓名和玩家输入框
                const nameInput = basicInfoSection.querySelector('.field-row:nth-child(2) .field-input');
                const playerInput = basicInfoSection.querySelector('.field-row:nth-child(3) .field-input');
                
                if (!nameInput) {
                    console.error('未找到姓名输入框');
                }
                
                if (!playerInput) {
                    console.error('未找到玩家输入框');
                }

                // 创建保存数据对象
                const data = {
                    basicInfo: {
                        name: nameInput ? nameInput.value : '',
                        player: playerInput ? playerInput.value : ''
                    },
                    characteristics: {},
                    avatar: document.getElementById('avatar-preview').src,
                    stats: {
                        san: {},
                        hp: {},
                        mp: {}
                    },
                    skillPoints: {
                        occupation: document.getElementById('occupation-points').value,
                        interest: document.getElementById('interest-points').value
                    },
                    skills: [],
                    customSkills: [],
                    weapons: [],
                    combat: {},
                    items: []
                };
                
                // 收集伙伴复选框状态
                const partnerCheckbox = document.querySelector('.partner-checkbox-container .partner-checkbox');
                if (partnerCheckbox) {
                    data.basicInfo.isPartner = partnerCheckbox.checked;
                }
                
                // 收集其他基本信息
                const otherInfoSelectors = {
                    era: '.field-row:nth-child(4) .field-group:nth-child(1) .field-input',
                    occupation: '.field-row:nth-child(4) .field-group:nth-child(2) .field-input',
                    age: '.field-row:nth-child(5) .field-group:nth-child(1) .field-input',
                    gender: '.field-row:nth-child(5) .field-group:nth-child(2) .field-input',
                    residence: '.field-row:nth-child(6) .field-group:nth-child(1) .field-input',
                    birthplace: '.field-row:nth-child(6) .field-group:nth-child(2) .field-input'
                };

                // 遍历收集其他信息
                Object.entries(otherInfoSelectors).forEach(([key, selector]) => {
                    const element = document.querySelector('.basic-info-section ' + selector);
                    if (element) {
                        data.basicInfo[key] = element.value || '';
                    }
                });
                
                // 收集特征值
                const charFields = {
                    'str': 'str', 'con': 'con', 'siz': 'siz', 'dex': 'dex', 
                    'app': 'app', 'int': 'int', 'pow': 'pow', 'edu': 'edu'
                };
                
                Object.entries(charFields).forEach(([id, key]) => {
                    const input = document.getElementById(id);
                    if (input) {
                        data.characteristics[key] = input.value;
                    }
                });
                
                // 收集理智值、体力值和魔法值数据
                const statFields = {
                    san: ['initial', 'current', 'max'],
                    hp: ['initial', 'current', 'max'],
                    mp: ['initial', 'current', 'max']
                };
                
                Object.entries(statFields).forEach(([stat, fields]) => {
                    fields.forEach(field => {
                        const input = document.getElementById(`${stat}-${field}`);
                        if (input) {
                            data.stats[stat][field] = input.value;
                        }
                    });
                });
                
                // 收集技能数据
                document.querySelectorAll('.skill-item').forEach(item => {
                    const skillName = item.dataset.skillName;
                    if (!skillName) return;
                    
                    // 收集各种点数
                    const occupationInput = item.querySelector('.occupation-points');
                    const interestInput = item.querySelector('.interest-points');
                    const growthInput = item.querySelector('.growth-points');
                    const subtypeDisplay = item.querySelector('.skill-subtype-display');
                    const isOccupationCheckbox = item.querySelector('.skill-checkbox');
                    
                    // 创建技能对象 - 使用安全获取值的方式
                    const skill = {
                        name: skillName,
                        occupation: (occupationInput && occupationInput.value !== undefined) ? occupationInput.value : '',
                        interest: (interestInput && interestInput.value !== undefined) ? interestInput.value : '',
                        growth: (growthInput && growthInput.value !== undefined) ? growthInput.value : '',
                        subtype: (subtypeDisplay && subtypeDisplay.style.display !== 'none') ? (subtypeDisplay.textContent || '') : '',
                        isOccupation: isOccupationCheckbox ? isOccupationCheckbox.checked : false
                    };
                    
                    data.skills.push(skill);
                });
                
                // 收集自定义技能数据
                document.querySelectorAll('.custom-skill-item').forEach(item => {
                    // 排除空项
                    if (item.style.visibility === 'hidden') return;
                    
                    const nameInput = item.querySelector('.custom-skill-name-input');
                    // 添加安全检查
                    if (!nameInput || !nameInput.value || typeof nameInput.value.trim !== 'function' || !nameInput.value.trim()) return;
                    
                    // 收集各种点数
                    const occupationInput = item.querySelector('.custom-occupation-points');
                    const interestInput = item.querySelector('.custom-interest-points');
                    const growthInput = item.querySelector('.custom-growth-points');
                    
                    // 创建技能对象 - 使用安全获取值的方式
                    const skill = {
                        name: nameInput.value || '',
                        occupation: (occupationInput && occupationInput.value !== undefined) ? occupationInput.value : '',
                        interest: (interestInput && interestInput.value !== undefined) ? interestInput.value : '',
                        growth: (growthInput && growthInput.value !== undefined) ? growthInput.value : ''
                    };
                    
                    data.customSkills.push(skill);
                });
                
                // 收集武器数据
                document.querySelectorAll('.weapon-row').forEach(row => {
                    const nameInput = row.querySelector('.weapon-name');
                    // 添加安全检查
                    if (!nameInput || !nameInput.value || typeof nameInput.value.trim !== 'function' || !nameInput.value.trim()) return;
                    
                    const damageInput = row.querySelector('.weapon-damage');
                    const rangeInput = row.querySelector('.weapon-range');
                    const attacksInput = row.querySelector('.weapon-attacks');
                    const ammoInput = row.querySelector('.weapon-ammo');
                    const malfunctionInput = row.querySelector('.weapon-malfunction');
                    const featureInput = row.querySelector('.weapon-feature');
                    
                    // 创建武器对象 - 使用安全获取值的方式
                    const weapon = {
                        name: nameInput.value || '',
                        damage: (damageInput && damageInput.value !== undefined) ? damageInput.value : '',
                        range: (rangeInput && rangeInput.value !== undefined) ? rangeInput.value : '',
                        attacks: (attacksInput && attacksInput.value !== undefined) ? attacksInput.value : '',
                        ammo: (ammoInput && ammoInput.value !== undefined) ? ammoInput.value : '',
                        malfunction: (malfunctionInput && malfunctionInput.value !== undefined) ? malfunctionInput.value : '',
                        feature: (featureInput && featureInput.value !== undefined) ? featureInput.value : ''
                    };
                    
                    data.weapons.push(weapon);
                });
                
                // 收集战斗数据
                const combatFields = {
                    'spirit': 'spirit',
                    'build': 'build',
                    'armor': 'armor'
                };
                
                Object.entries(combatFields).forEach(([id, key]) => {
                    const input = document.getElementById(id);
                    if (input) {
                        data.combat[key] = input.value;
                    }
                });
                
                // 收集道具数据
                document.querySelectorAll('.item-row').forEach(row => {
                    const nameInput = row.querySelector('.item-name');
                    if (!nameInput) return;
                    
                    const categoryDisplay = row.querySelector('.category-display');
                    const notesInput = row.querySelector('.item-notes');
                    
                    // 添加安全检查，确保value属性存在
                    const itemName = nameInput.value || '';
                    const itemCategory = (categoryDisplay && categoryDisplay.style.display !== 'none') 
                        ? (categoryDisplay.dataset.category || '') 
                        : '';
                    const itemNotes = (notesInput && notesInput.value !== undefined) ? notesInput.value : '';
                    
                    const item = {
                        name: itemName,
                        category: itemCategory,
                        notes: itemNotes
                    };
                    
                    data.items.push(item);
                });
                
                // 检查是否有数据填写
                const hasData = (
                    data.basicInfo.name || 
                    data.basicInfo.player || 
                    Object.values(data.characteristics).some(v => v) ||
                    (data.avatar && data.avatar !== window.location.href) ||
                    Object.values(data.stats.san).some(v => v) ||
                    Object.values(data.stats.hp).some(v => v) ||
                    Object.values(data.stats.mp).some(v => v) ||
                    data.skillPoints.occupation ||
                    data.skillPoints.interest ||
                    data.skills.some(s => s.occupation || s.interest || s.growth || s.subtype) ||
                    data.customSkills.some(s => s.name || s.occupation || s.interest || s.growth) ||
                    data.weapons.some(w => w.name || w.damage || w.feature) ||
                    Object.values(data.combat).some(v => v)
                );

                if (!hasData) {
                    if (showAlert) {
                    alert('表单为空，无需保存。');
                    }
                    return;
                }

                // 保存到localStorage
                localStorage.setItem('characterSheet', JSON.stringify(data));
                
                // 只在需要显示提示时才显示
                if (showAlert) {
                alert('保存成功！');
                }
            } catch (error) {
                console.error('保存时发生错误:', error);
                if (showAlert) {
                alert('保存失败，请检查控制台获取详细信息。');
                }
            }
        }

        // 加载功能
        function loadCharacterSheet() {
            // 设置加载标志，防止触发保存操作
            window.isLoading = true;
            
            try {
                // 获取保存的数据
                const savedData = localStorage.getItem('characterSheet');
                if (!savedData) {
                    console.log('没有找到保存的数据');
                    return;
                }

                // 解析数据
                let data;
                try {
                    data = JSON.parse(savedData);
                    console.log('正在加载数据:', data);
                } catch (parseError) {
                    console.error('解析保存的数据时出错:', parseError);
                    throw new Error('数据格式错误');
                }

                // 基本信息
                if (data.basicInfo) {
                    try {
                        console.log('开始加载基本信息...');
                        
                        // 使用更精确的选择器
                        const nameInput = document.querySelector('.basic-info-section .field-row:nth-child(2) .field-input');
                        const playerInput = document.querySelector('.basic-info-section .field-row:nth-child(3) .field-input');
                        
                        // 设置姓名和玩家名称
                        if (nameInput && data.basicInfo.name !== undefined) {
                            console.log('设置姓名:', data.basicInfo.name);
                            nameInput.value = data.basicInfo.name;
                        }
                        
                        if (playerInput && data.basicInfo.player !== undefined) {
                            console.log('设置玩家名称:', data.basicInfo.player);
                            playerInput.value = data.basicInfo.player;
                        }
                        
                        // 其他基本信息的设置
                        const otherInfoSelectors = {
                            era: '.field-row:nth-child(4) .field-group:nth-child(1) .field-input',
                            occupation: '.field-row:nth-child(4) .field-group:nth-child(2) .field-input',
                            age: '.field-row:nth-child(5) .field-group:nth-child(1) .field-input',
                            gender: '.field-row:nth-child(5) .field-group:nth-child(2) .field-input',
                            residence: '.field-row:nth-child(6) .field-group:nth-child(1) .field-input',
                            birthplace: '.field-row:nth-child(6) .field-group:nth-child(2) .field-input'
                        };

                        // 遍历设置其他信息
                        Object.entries(otherInfoSelectors).forEach(([key, selector]) => {
                            const element = document.querySelector('.basic-info-section ' + selector);
                            if (element && data.basicInfo[key] !== undefined) {
                                console.log(`设置 ${key} 的值:`, data.basicInfo[key]);
                                element.value = data.basicInfo[key];
                            }
                        });

                        // 伙伴复选框
                        const partnerCheckbox = document.querySelector('.partner-checkbox-container .partner-checkbox');
                        if (partnerCheckbox) {
                            console.log('设置伙伴复选框状态:', data.basicInfo.isPartner);
                            partnerCheckbox.checked = Boolean(data.basicInfo.isPartner);
                        }

                        // 同步调查员信息到引用区域
                        setTimeout(syncInvestigatorInfo, 0);
                    } catch (basicInfoError) {
                        console.error('加载基本信息时出错:', basicInfoError);
                    }
                }

                // 属性值
                if (data.characteristics) {
                    try {
                        const attrIds = ['str', 'con', 'dex', 'app', 'siz', 'edu', 'int', 'pow', 'luc'];
                        attrIds.forEach(id => {
                            const input = document.getElementById(id);
                            if (input && data.characteristics[id] !== undefined) {
                                input.value = data.characteristics[id];
                                // 使用setTimeout确保值被设置后再触发事件
                                setTimeout(() => {
                                    const event = new Event('input', { bubbles: true });
                                    input.dispatchEvent(event);
                                    
                                    // 如果是意志属性，更新理智值起始值
                                    if (id === 'pow') {
                                        updateStartingSanity();
                                    }
                                }, 0);
                            }
                        });
                    } catch (charError) {
                        console.error('加载属性值时出错:', charError);
                    }
                }

                // 头像
                if (data.avatar) {
                    try {
                        const avatarPreview = document.getElementById('avatar-preview');
                        const avatarPlaceholder = document.querySelector('.avatar-placeholder');
                        if (avatarPreview && data.avatar && data.avatar !== window.location.href) {
                            avatarPreview.src = data.avatar;
                            if (avatarPlaceholder) {
                                avatarPlaceholder.style.display = 'none';
                            }
                        }
                    } catch (avatarError) {
                        console.error('加载头像时出错:', avatarError);
                    }
                }

                // 状态值
                if (data.stats) {
                    try {
                        const statsConfig = {
                            san: ['current', 'start', 'max'],
                            hp: ['current', 'max', 'temp'],
                            mp: ['current', 'max', 'temp']
                        };

                        Object.entries(statsConfig).forEach(([type, fields]) => {
                            fields.forEach(field => {
                                const input = document.getElementById(`${field}-${type}`);
                                if (input && data.stats[type] && data.stats[type][field] !== undefined) {
                                    input.value = data.stats[type][field];
                                }
                            });
                        });
                    } catch (statsError) {
                        console.error('加载状态值时出错:', statsError);
                    }
                }

                // 技能点数
                if (data.skillPoints) {
                    try {
                        ['occupation', 'interest'].forEach(type => {
                            const input = document.getElementById(`${type}-points`);
                            if (input && data.skillPoints[type] !== undefined) {
                                input.value = data.skillPoints[type];
                                // 触发输入事件以更新计算
                                setTimeout(() => {
                                    const event = new Event('input', { bubbles: true });
                                    input.dispatchEvent(event);
                                }, 0);
                            }
                        });
                        // 计算剩余点数
                        calculateRemainingPoints();
                    } catch (pointsError) {
                        console.error('加载技能点数时出错:', pointsError);
                    }
                }

                // 技能
                if (data.skills && Array.isArray(data.skills)) {
                    try {
                        const skillItems = document.querySelectorAll('.skill-item');
                        data.skills.forEach((skill, index) => {
                            if (!skill || !skillItems[index]) return;

                            const item = skillItems[index];
                            
                            // 职业技能复选框
                            const checkbox = item.querySelector('.skill-checkbox');
                            if (checkbox) {
                                checkbox.checked = Boolean(skill.isOccupation);
                            }

                            // 子技能
                            if (skill.subtype) {
                                const btn = item.querySelector('.skill-subtype-btn');
                                const display = item.querySelector('.skill-subtype-display');
                                const baseElement = item.querySelector('.skill-base');
                                const skillName = item.dataset.skillName;
                                
                                if (btn && display && baseElement) {
                                    btn.textContent = '更改';
                                    display.textContent = skill.subtype;
                                    display.style.display = 'inline-block';
                                    
                                    // 查找对应技能的基础值
                                    const skillData = skillsData.find(s => s.name === skillName);
                                    if (skillData && skillData.subtypes) {
                                        // 如果子技能是对象数组（如格斗技能）
                                        if (skillData.subtypes[0] && typeof skillData.subtypes[0] === 'object') {
                                            const subtype = skillData.subtypes.find(st => st.name === skill.subtype);
                                            if (subtype) {
                                                baseElement.textContent = subtype.base;
                                            }
                                        } else {
                                            // 如果子技能是字符串数组（如语言技能）
                                            baseElement.textContent = skillData.base;
                                            // 如果是母语技能，设置为激活状态
                                            if (skillName === '母语') {
                                                baseElement.dataset.baseType = "edu-active";
                                                const eduValue = document.getElementById('edu')?.value || '0';
                                                baseElement.textContent = eduValue;
                                            }
                                        }
                                    }
                                }
                            }

                            // 点数
                            ['occupation', 'interest', 'growth'].forEach(type => {
                                const input = item.querySelector(`.${type}-points`);
                                if (input && skill[type] !== undefined) {
                                    input.value = skill[type];
                                }
                            });

                            // 触发计算
                            const occInput = item.querySelector('.occupation-points');
                            if (occInput) {
                                setTimeout(() => {
                                    const event = new Event('input', { bubbles: true });
                                    occInput.dispatchEvent(event);
                                }, 0);
                            }
                        });
                    } catch (skillsError) {
                        console.error('加载技能时出错:', skillsError);
                    }
                }

                // 自定义技能
                if (data.customSkills && Array.isArray(data.customSkills)) {
                    try {
                        const customItems = document.querySelectorAll('.custom-skill-item');
                        data.customSkills.forEach((skill, index) => {
                            if (!skill || !customItems[index]) return;

                            const item = customItems[index];
                            
                            // 确保可见
                            item.style.visibility = 'visible';
                            
                            // 技能名称
                            const nameInput = item.querySelector('.custom-skill-name-input');
                            if (nameInput && skill.name !== undefined) {
                                nameInput.value = skill.name;
                            }

                            // 点数
                            ['occupation', 'interest', 'growth'].forEach(type => {
                                const input = item.querySelector(`.custom-${type}-points`);
                                if (input && skill[type] !== undefined) {
                                    input.value = skill[type];
                                }
                            });

                            // 触发计算
                            const occInput = item.querySelector('.custom-occupation-points');
                            if (occInput) {
                                setTimeout(() => {
                                    const event = new Event('input', { bubbles: true });
                                    occInput.dispatchEvent(event);
                                }, 0);
                            }
                        });
                    } catch (customSkillsError) {
                        console.error('加载自定义技能时出错:', customSkillsError);
                    }
                }

                // 武器
                if (data.weapons && Array.isArray(data.weapons)) {
                    try {
                        const weaponRows = document.querySelectorAll('.weapon-row');
                        data.weapons.forEach((weapon, index) => {
                            if (!weapon || !weaponRows[index]) return;

                            const row = weaponRows[index];
                            ['name', 'damage', 'feature'].forEach(type => {
                                const text = row.querySelector(`.weapon-${type}-text`);
                                if (text && weapon[type] !== undefined) {
                                    text.textContent = weapon[type];
                                }
                            });
                        });
                    } catch (weaponsError) {
                        console.error('加载武器时出错:', weaponsError);
                    }
                }

                // 战斗数据
                if (data.combat) {
                    try {
                        const combatFields = {
                            'spirit': 'spirit',
                            'build': 'build',
                            'armor': 'armor'
                        };

                        Object.entries(combatFields).forEach(([id, key]) => {
                            const input = document.getElementById(id);
                            if (input && data.combat[key] !== undefined) {
                                input.value = data.combat[key];
                            }
                        });
                        
                        // 重新计算伤害加值和精神加值
                        calculateDamageBonus();
                        calculateSpiritBonus();
                    } catch (combatError) {
                        console.error('加载战斗数据时出错:', combatError);
                    }
                }

                // 道具数据
                if (data.items && Array.isArray(data.items)) {
                    try {
                        const itemRows = document.querySelectorAll('.item-row');
                        data.items.forEach((item, index) => {
                            if (index < itemRows.length && item) {
                                const row = itemRows[index];
                                const nameInput = row.querySelector('.item-name');
                                const categoryBtn = row.querySelector('.category-select-btn');
                                const categoryDisplay = row.querySelector('.category-display');
                                const notesInput = row.querySelector('.item-notes');
                                
                                if (nameInput && item.name) nameInput.value = item.name;
                                
                                // 设置类别显示
                                if (categoryBtn && categoryDisplay && item.category) {
                                    categoryDisplay.textContent = item.category;
                                    categoryDisplay.style.display = 'inline-block';
                                    categoryDisplay.dataset.category = item.category;
                                    categoryBtn.textContent = '更改';
                                    categoryBtn.classList.add('has-selection');
                                }
                                
                                if (notesInput && item.notes) notesInput.value = item.notes;
                            }
                        });
                    } catch (itemsError) {
                        console.error('加载道具数据时出错:', itemsError);
                    }
                }
                
                // ... existing code ...

                // 最后更新所有计算
                setTimeout(() => {
                    try {
                        // 更新属性总值
                        calculateTotalAttr();
                        // 更新语言技能基础值
                        updateLanguageBaseValues();
                        // 更新剩余点数
                        calculateRemainingPoints();
                    } catch (calcError) {
                        console.error('更新计算时出错:', calcError);
                    }
                    
                    // 显示载入成功提示
                    const loadSuccessDiv = document.createElement('div');
                    loadSuccessDiv.textContent = '载入成功!';
                    loadSuccessDiv.style.position = 'fixed';
                    loadSuccessDiv.style.top = '50%';
                    loadSuccessDiv.style.left = '50%';
                    loadSuccessDiv.style.transform = 'translate(-50%, -50%)';
                    loadSuccessDiv.style.backgroundColor = '#fff';
                    loadSuccessDiv.style.padding = '15px 20px';
                    loadSuccessDiv.style.borderRadius = '5px';
                    loadSuccessDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                    loadSuccessDiv.style.zIndex = '9999';
                    document.body.appendChild(loadSuccessDiv);
                    
                    // 2秒后自动移除提示
                    setTimeout(() => {
                        document.body.removeChild(loadSuccessDiv);
                        // 恢复加载标志
                        window.isLoading = false;
                    }, 2000);
                }, 100);

                console.log('数据加载成功');
            } catch (error) {
                console.error('加载数据时发生错误:', error);
                alert('加载失败，请检查控制台获取详细信息。');
                // 确保错误情况下也恢复加载标志
                window.isLoading = false;
            }
        }

        // 检查是否有保存的数据
        function checkSavedData() {
            try {
                // 获取保存的数据
                const savedData = localStorage.getItem('characterSheet');
                if (!savedData) {
                    return;
                }

                // 解析数据
                const data = JSON.parse(savedData);

                // 检查是否有基本信息数据
                if (!data.basicInfo) {
                    return;
                }

                // 获取角色名称，优先使用name字段，如果为空则使用player字段
                const characterName = data.basicInfo.name || data.basicInfo.player || "未命名角色";

                // 只有当有实际的角色名称或玩家名称时才显示对话框
                if (characterName !== "未命名角色") {
                    // 更新对话框中的角色名称
                    const nameElements = document.querySelectorAll('#saved-character-name');
                    nameElements.forEach(element => {
                        if (element) {
                            element.textContent = characterName;
                        }
                    });

                    // 显示加载对话框
                    const overlay = document.querySelector('.load-dialog-overlay');
                    const dialog = document.querySelector('.load-dialog');
                    
                    if (overlay && dialog) {
                        overlay.style.display = 'block';
                        dialog.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('检查保存的数据时出错:', error);
            }
        }

        // 添加更新理智值起始值的函数
        function updateStartingSanity() {
            const powInput = document.getElementById('pow');
            const startSanInput = document.getElementById('start-san');
            const currentSanInput = document.getElementById('current-san');
            const maxSanInput = document.getElementById('max-san');
            
            if (powInput && startSanInput) {
                const powValue = parseInt(powInput.value || 0);
                startSanInput.value = powValue;
                
                // 如果当前理智值为空，也设置为意志值
                if (currentSanInput && (!currentSanInput.value || currentSanInput.value === '0')) {
                    currentSanInput.value = powValue;
                }
                
                // 设置最大理智值为99
                if (maxSanInput) {
                    maxSanInput.value = '99';
                }
            }
        }

        // 为意志属性添加事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            const powInput = document.getElementById('pow');
            if (powInput) {
                powInput.addEventListener('input', updateStartingSanity);
                powInput.addEventListener('change', updateStartingSanity);
            }
        });

        // 在 JavaScript 部分添加自动计算伤害加值的函数
        function calculateDamageBonus() {
            const strInput = document.getElementById('str');
            const sizInput = document.getElementById('siz');
            const damageBonusInput = document.getElementById('damage-bonus');
            
            if (!strInput || !sizInput || !damageBonusInput) return;
            
            const str = parseInt(strInput.value || 0);
            const siz = parseInt(sizInput.value || 0);
            const total = str + siz;
            
            let bonus = '';
            if (total >= 285) {
                bonus = '+3d6';
            } else if (total >= 205) {
                bonus = '+2d6';
            } else if (total >= 165) {
                bonus = '+1d6';
            } else if (total >= 125) {
                bonus = '+1d4';
            } else if (total >= 85) {
                bonus = '+0';
            } else if (total >= 65) {
                bonus = '-1d4';
            } else {
                bonus = '-1d6';
            }
            
            damageBonusInput.value = bonus;
        }

        // 在 JavaScript 部分添加自动计算精神加值的函数
        function calculateSpiritBonus() {
            const intInput = document.getElementById('int');
            const powInput = document.getElementById('pow');
            const spiritBonusInput = document.getElementById('spirit-bonus');
            
            if (!intInput || !powInput || !spiritBonusInput) return;
            
            const int = parseInt(intInput.value || 0);
            const pow = parseInt(powInput.value || 0);
            const total = int + pow;
            
            let bonus = '';
            if (total >= 285) {
                bonus = '+3d6';
            } else if (total >= 205) {
                bonus = '+2d6';
            } else if (total >= 165) {
                bonus = '+1d6';
            } else if (total >= 125) {
                bonus = '+1d4';
            } else if (total >= 85) {
                bonus = '+0';
            } else if (total >= 65) {
                bonus = '-1d4';
            } else {
                bonus = '-1d6';
            }
            
            spiritBonusInput.value = bonus;
        }

        // 添加自动计算体格的函数
        function calculateBuild() {
            const strInput = document.getElementById('str');
            const sizInput = document.getElementById('siz');
            const buildInput = document.getElementById('build');
            
            if (!strInput || !sizInput || !buildInput) return;
            
            const str = parseInt(strInput.value || 0);
            const siz = parseInt(sizInput.value || 0);
            const total = str + siz;
            
            let build = '';
            if (total >= 285) {
                build = '4';
            } else if (total >= 205) {
                build = '3';
            } else if (total >= 165) {
                build = '2';
            } else if (total >= 125) {
                build = '1';
            } else if (total >= 85) {
                build = '0';
            } else if (total >= 65) {
                build = '-1';
            } else {
                build = '-2';
            }
            
            buildInput.value = build;
        }

        // 在属性计算函数中添加对体格的计算
        function calculateTotalAttr() {
            const attrInputs = [
                document.getElementById('str'),
                document.getElementById('con'),
                document.getElementById('dex'),
                document.getElementById('app'),
                document.getElementById('siz'),
                document.getElementById('edu'),
                document.getElementById('int'),
                document.getElementById('pow'),
                document.getElementById('luc')
            ];
            
            let total = 0;
            attrInputs.forEach(input => {
                total += parseInt(input.value || 0);
            });
            
            const totalAttr = document.getElementById('total-attr');
            if (totalAttr) {
                totalAttr.textContent = total;
            }
            
            // 更新闪避值（敏捷的一半）
            updateDodgeValue();
            
            // 计算伤害加值
            calculateDamageBonus();
            
            // 计算精神加值
            calculateSpiritBonus();
            
            // 计算体格
            calculateBuild();
        }

        // 设置道具页面功能
        document.addEventListener('DOMContentLoaded', function() {
            // 道具容器元素
            const itemsContainer = document.getElementById('items-container');
            // 道具名称在顶部引用
            const refNameItems = document.getElementById('ref-name-items');
            
            // 装备和道具类型
            const itemCategories = [
                "装备-头部", "装备-肩部", "装备-背部", "装备-躯干", 
                "装备-手部", "装备-腿部", "装备-脚部", "装备-饰品", 
                "常驻道具", "消耗品", "其他"
            ];
            
            // 引用主角色卡姓名
            const mainNameInput = document.getElementById('investigator-name');
            if (mainNameInput && refNameItems) {
                // 初始加载时同步名称
                refNameItems.textContent = mainNameInput.value || "-";
                
                // 名称变更时同步
                mainnameInput.addEventListener('input', function() {
    const inputValue = this.value || '-';
    if (refName) {
        refName.textContent = inputValue;
    }
    if (refNameItems) {
        refNameItems.textContent = inputValue;
    }
});
            }
            
            // 生成道具行
            function createItemRow() {
                const row = document.createElement('div');
                row.className = 'item-row';
                
                // 名称单元格
                const nameCell = document.createElement('div');
                nameCell.className = 'item-cell';
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'item-name';
                nameInput.placeholder = '道具名称';
                nameCell.appendChild(nameInput);
                
                // 类别单元格
                const categoryCell = document.createElement('div');
                categoryCell.className = 'item-cell';
                
                // 创建类别选择按钮和显示区域
                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = 'category-wrapper';
                
                // 添加类别选择按钮
                const selectBtn = document.createElement('div');
                selectBtn.className = 'skill-subtype-btn category-select-btn';
                selectBtn.textContent = '选择类别...';
                selectBtn.addEventListener('click', function(event) {
                    // 防止事件冒泡，避免触发保存
                    event.stopPropagation();
                    openCategoryModal(this, event);
                });
                
                // 创建选中后的显示区域
                const categoryDisplay = document.createElement('span');
                categoryDisplay.className = 'skill-subtype-display category-display';
                categoryDisplay.style.display = 'none';
                
                categoryWrapper.appendChild(selectBtn);
                categoryWrapper.appendChild(categoryDisplay);
                categoryCell.appendChild(categoryWrapper);
                
                // 备注/描述单元格
                const notesCell = document.createElement('div');
                notesCell.className = 'item-cell';
                const notesInput = document.createElement('input');
                notesInput.type = 'text';
                notesInput.className = 'item-notes';
                notesInput.placeholder = '备注/描述';
                notesCell.appendChild(notesInput);
                
                // 将所有单元格添加到行
                row.appendChild(nameCell);
                row.appendChild(categoryCell);
                row.appendChild(notesCell);
                
                // 为道具信息添加保存事件，但不显示提示
                nameInput.addEventListener('change', function() {
                    // 使用静默保存模式，不显示任何提示
                    try {
                        saveCharacterSheet(false);
                    } catch (error) {
                        console.error('保存道具信息时出错:', error);
                        // 不显示错误提示
                    }
                });
                notesInput.addEventListener('change', function() {
                    // 使用静默保存模式，不显示任何提示
                    try {
                        saveCharacterSheet(false);
                    } catch (error) {
                        console.error('保存道具信息时出错:', error);
                        // 不显示错误提示
                    }
                });
                
                // 使用MutationObserver监听类别显示变化，替代弃用的DOMSubtreeModified
                const observer = new MutationObserver(function(mutations) {
                    let shouldSave = false;
                    
                    mutations.forEach(function(mutation) {
                        // 只处理实际发生变化的情况
                        if (mutation.type === 'attributes' && 
                            (mutation.attributeName === 'style' || 
                             mutation.attributeName === 'data-category')) {
                            shouldSave = true;
                        } else if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            shouldSave = true;
                        }
                    });
                    
                    if (shouldSave) {
                        try {
                            // 使用静默保存模式，不显示任何提示
                            saveCharacterSheet(false);
                        } catch (error) {
                            console.error('监听到类别变化后保存时出错:', error);
                            // 不显示错误提示
                        }
                    }
                });
                
                // 配置观察选项 - 只观察真正需要的变化
                const config = { 
                    attributes: true,
                    attributeFilter: ['style', 'data-category'], 
                    childList: true,
                    subtree: false  // 不需要观察子树变化
                };
                
                // 开始观察
                observer.observe(categoryDisplay, config);
                
                return row;
            }
            
            // 生成道具项目列表
            if (itemsContainer) {
                // 创建30个道具行
                const totalItems = 30;
                for (let i = 0; i < totalItems; i++) {
                    const itemRow = createItemRow();
                    itemsContainer.appendChild(itemRow);
                }
            }
            
            // 道具类别选择模态窗口功能
            const categoryModal = document.getElementById('category-modal');
            const closeCategoryBtn = document.querySelector('.close-category-modal');
            const categoryList = document.getElementById('category-list');
            
            let currentCategoryButton = null;
            
            // 打开类别选择模态窗口
            function openCategoryModal(button, event) {
                // 防止事件冒泡，避免触发父元素上的事件处理器
                if (event) {
                    event.stopPropagation();
                }
                
                currentCategoryButton = button;
                
                // 清空列表
                categoryList.innerHTML = '';
                
                // 添加分类标题
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'subtype-category';
                categoryTitle.textContent = '道具类别';
                categoryList.appendChild(categoryTitle);
                
                // 填充类别列表
                itemCategories.forEach(category => {
                    addCategoryItem(category);
                });
                
                // 显示模态窗口
                categoryModal.style.display = 'block';
            }
            
            // 添加类别项
            function addCategoryItem(category) {
                const item = document.createElement('div');
                item.className = 'subtype-item';
                item.textContent = category;
                item.addEventListener('click', function() {
                    selectCategory(category);
                });
                categoryList.appendChild(item);
            }
            
            // 选择类别
            function selectCategory(category) {
                if (!currentCategoryButton) return;
                
                // 找到父元素
                const itemRow = currentCategoryButton.closest('.item-row');
                if (!itemRow) return;
                
                // 更新显示
                const categoryDisplay = itemRow.querySelector('.category-display');
                if (!categoryDisplay) {
                    console.error('找不到类别显示元素');
                    return;
                }
                
                categoryDisplay.textContent = category;
                categoryDisplay.style.display = 'inline-block';
                categoryDisplay.dataset.category = category; // 存储类别值
                
                // 不再隐藏选择按钮，而是改变其文本
                currentCategoryButton.textContent = '更改';
                currentCategoryButton.style.display = 'inline-block'; // 确保按钮仍然可见
                
                // 添加类来区分选择前后的状态
                currentCategoryButton.classList.add('has-selection');
                
                // 关闭模态窗口
                closeCategoryModal();
                
                // 修改为在setTimeout内部使用try/catch
                setTimeout(() => {
                    try {
                        // 直接触发保存，因为MutationObserver可能不会立即响应，但不显示保存成功提示
                        saveCharacterSheet(false);
                    } catch (error) {
                        console.error('选择类别后保存时出错:', error);
                        // 不显示错误提示
                    }
                }, 0);
            }
            
            // 关闭模态窗口
            function closeCategoryModal() {
                categoryModal.style.display = 'none';
                currentCategoryButton = null;
            }
            
            // 点击关闭按钮
            closeCategoryBtn.addEventListener('click', closeCategoryModal);
            
            // 点击模态窗口外部关闭
            window.addEventListener('click', function(e) {
                if (e.target === categoryModal) {
                    closeCategoryModal();
                }
            });
            
            // 按ESC键关闭
            window.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && categoryModal.style.display === 'block') {
                    closeCategoryModal();
                }
            });
            
            // 在加载角色数据时添加道具加载功能
            const originalLoadCharacterData = window.loadCharacterData;
            if (typeof originalLoadCharacterData === 'function') {
                window.loadCharacterData = function(data) {
                    // 调用原始加载函数
                    originalLoadCharacterData(data);
                    
                    // 加载道具数据
                    if (data.items && Array.isArray(data.items)) {
                        const itemRows = document.querySelectorAll('.item-row');
                        data.items.forEach((item, index) => {
                            if (index < itemRows.length) {
                                const row = itemRows[index];
                                const nameInput = row.querySelector('.item-name');
                                const categoryBtn = row.querySelector('.category-select-btn');
                                const categoryDisplay = row.querySelector('.category-display');
                                const notesInput = row.querySelector('.item-notes');
                                
                                if (nameInput && item.name) nameInput.value = item.name;
                                
                                // 设置类别显示
                                if (categoryBtn && categoryDisplay && item.category) {
                                    categoryDisplay.textContent = item.category;
                                    categoryDisplay.style.display = 'inline-block';
                                    categoryDisplay.dataset.category = item.category;
                                    categoryBtn.textContent = '更改';
                                    categoryBtn.classList.add('has-selection');
                                }
                                
                                if (notesInput && item.notes) notesInput.value = item.notes;
                            }
                        });
                    }
                };
            }
            
            // 在保存角色数据时添加道具保存功能
            const originalSaveCharacterData = window.saveCharacterData;
            if (typeof originalSaveCharacterData === 'function') {
                window.saveCharacterData = function() {
                    // 获取原始保存数据
                    const data = originalSaveCharacterData();
                    
                    // 添加道具数据
                    data.items = [];
                    const itemRows = document.querySelectorAll('.item-row');
                    itemRows.forEach(row => {
                        const nameInput = row.querySelector('.item-name');
                        const categoryDisplay = row.querySelector('.category-display');
                        const notesInput = row.querySelector('.item-notes');
                        
                        // 只保存有内容的道具项
                        if (nameInput.value || (categoryDisplay && categoryDisplay.textContent) || notesInput.value) {
                            data.items.push({
                                name: nameInput.value,
                                category: categoryDisplay ? categoryDisplay.textContent : '',
                                notes: notesInput.value
                            });
                        }
                    });
                    
                    return data;
                };
            }
        });
    </script>
    
    <!-- 额外的打印样式，确保战斗区域边框可见 -->
    <style>
        @media print {
            /* 使用最高优先级确保战斗区域边框在打印时可见 */
            html body .character-sheet .combat-section {
                border: 1px solid black !important;
                border-width: 1px !important;
                border-style: solid !important;
                border-color: black !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* 确保不显示最外层边框 */
            html body .character-sheet,
            html body .custom-page,
            html body .items-page {
                border: none !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* 确保战斗区域标签文字不加粗 */
            html body .character-sheet .combat-section .combat-label {
                font-weight: normal !important;
            }
            
            /* 确保战斗区域行间距在打印时保持一致 */
            html body .character-sheet .combat-section .combat-grid {
                gap: 3px !important;
            }
            
            html body .character-sheet .combat-section .combat-row {
                min-height: 20px !important;
                margin-bottom: 1px !important;
            }
            
            /* 确保宽度比例在打印时保持一致 */
            html body .character-sheet .combat-section .combat-label {
                width: 65% !important;
                font-weight: normal !important;
            }
            
            html body .character-sheet .combat-section .combat-value {
                width: 35% !important;
            }
            
            /* 确保战斗区域输入框在打印时使用白色背景 */
            html body .character-sheet .combat-section .combat-input {
                background-color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* 确保所有颜色和边框在打印时正确显示 */
            html body * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* 防止打印空白页的额外强化设置 */
            @page {
                margin: 0.5cm !important;
                size: A4 portrait !important;
            }
            
            /* 确保文档没有多余内容 */
            html::after, body::after, .character-sheet::after, .custom-page::after, .items-page::after {
                content: none !important;
                display: none !important;
            }
            
            /* 隐藏所有可能导致空白页的元素 */
            html body *:empty:not(input):not(textarea):not(.modal *):not(script):not(style) {
                display: none !important;
            }
        }
    </style>
</body>
</html>